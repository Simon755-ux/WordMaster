<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√ñva glosor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 95vh;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .container {
                padding: 40px;
                max-height: 90vh;
            }
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 2.5em;
                margin-bottom: 30px;
            }
        }

        h2 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
        }

        @media (min-width: 768px) {
            h2 {
                margin-bottom: 20px;
                font-size: 1.5em;
            }
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            touch-action: manipulation;
        }

        button:hover, button:active {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button.small {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        .hidden {
            display: none;
        }

        .glos-input-container {
            max-height: 50vh;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }

        .glos-row {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .glos-row input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        .header-row {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: bold;
            color: #667eea;
            font-size: 0.9em;
        }

        .verb-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .verb-form input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .verb-form label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-top: 8px;
            font-size: 0.9em;
        }

        .word-panel {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            text-align: center;
            font-size: 1.3em;
            color: #333;
        }

        .input-box {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 3px solid #ddd;
            border-radius: 10px;
            margin: 10px 0;
        }

        .input-box.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .irreg-input-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }

        .irreg-label {
            min-width: 80px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }

        .feedback {
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-size: 1em;
            font-weight: bold;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .feedback.wrong {
            background: #f8d7da;
            color: #721c24;
        }

        .progress {
            text-align: center;
            margin: 15px 0;
            font-size: 1em;
            color: #555;
        }

        .score {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            font-size: 1.2em;
        }

        .score-correct {
            color: #28a745;
        }

        .score-wrong {
            color: #dc3545;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            max-width: 500px;
            margin: 0 auto 15px;
            font-size: 1em;
            font-weight: bold;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 35px);
            grid-template-rows: repeat(8, 35px);
            gap: 2px;
            background: #ddd;
            padding: 5px;
            border-radius: 10px;
            margin: 15px auto;
            width: fit-content;
        }

        .cell {
            width: 35px;
            height: 35px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .cell.filled {
            background: #667eea;
        }

        .cell:hover, .cell:active {
            background: #f0f0f0;
        }

        .cell.valid-drop {
            background: #b3e5b3 !important;
            border-color: #28a745;
        }

        .cell.invalid-drop {
            background: #ffb3b3 !important;
            border-color: #dc3545;
        }

        .pieces-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .piece {
            display: inline-grid;
            gap: 2px;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            user-select: none;
            touch-action: none;
        }

        .piece:active {
            cursor: grabbing;
        }

        .piece:hover, .piece:active {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .piece.selected {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .piece.used {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .piece-cell {
            width: 25px;
            height: 25px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .piece-cell.active {
            background: #667eea;
        }

        .glos-question-panel {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            border: 3px solid #ffc107;
            margin: 15px 0;
        }

        .glos-question-panel h3 {
            color: #856404;
            margin-bottom: 12px;
            text-align: center;
            font-size: 1em;
        }

        .glos-question-panel .word {
            font-size: 1.4em;
            text-align: center;
            margin: 12px 0;
            color: #333;
        }

        .glos-question-panel input {
            width: 100%;
            max-width: 400px;
            display: block;
            margin: 12px auto;
            padding: 10px;
            font-size: 1em;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }

        .flipcard-container {
            perspective: 1000px;
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .flipcard {
            width: 100%;
            max-width: 500px;
            height: 200px;
            cursor: pointer;
        }

        .flipcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flipcard-inner.flipped {
            transform: rotateY(180deg);
        }

        .flipcard-front, .flipcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            font-size: 1.4em;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 20px;
            text-align: center;
        }

        .flipcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flipcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .mobile-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 60px);
            gap: 10px;
            max-width: 300px;
            margin: 20px auto;
            touch-action: none;
        }

        @media (min-width: 768px) {
            .mobile-controls {
                display: none;
            }
        }

        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            touch-action: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:active {
            background: #764ba2;
            transform: scale(0.95);
        }

        .control-btn.up {
            grid-column: 2;
            grid-row: 1;
        }

        .control-btn.left {
            grid-column: 1;
            grid-row: 2;
        }

        .control-btn.down {
            grid-column: 2;
            grid-row: 2;
        }

        .control-btn.right {
            grid-column: 3;
            grid-row: 2;
        }

        .control-btn.pause {
            grid-column: 1 / 4;
            grid-row: 3;
            background: #ffc107;
            color: #000;
        }

        #rocket-canvas {
            width: 100%;
            max-width: 800px;
            height: auto;
            border: 3px solid #667eea;
            border-radius: 10px;
            background: #000;
            display: block;
            margin: 15px auto;
            touch-action: none;
        }

        .controls-info {
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 0.85em;
        }

        /* ===== IMAGE UPLOAD STYLES ===== */
        .image-upload-section {
            background: linear-gradient(135deg, #e8f4fd 0%, #f0e8fd 100%);
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0 15px 0;
            text-align: center;
        }

        .image-upload-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .image-upload-section p {
            color: #888;
            font-size: 0.8em;
            margin-top: 6px;
        }

        .image-upload-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #667eea;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .image-upload-label:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .image-upload-preview {
            margin-top: 12px;
            display: none;
        }

        .image-upload-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #667eea;
            object-fit: cover;
        }

        .image-upload-preview .img-name {
            font-size: 0.8em;
            color: #555;
            margin-top: 5px;
        }

        .extract-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            margin-top: 10px;
            display: none;
            transition: all 0.2s;
        }

        .extract-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.4);
        }

        .extract-btn:disabled {
            background: #aaa;
            cursor: not-allowed;
            transform: none;
        }

        .extract-status {
            margin-top: 8px;
            font-size: 0.85em;
            font-weight: bold;
            min-height: 20px;
        }

        .extract-status.loading { color: #667eea; }
        .extract-status.success { color: #28a745; }
        .extract-status.error { color: #dc3545; }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 5px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>√ñva glosor</h1>
        
        <div id="screen-main-menu">
            <h2>V√§lj vad du vill g√∂ra:</h2>
            <div class="button-group">
                <button onclick="selectType('glosor')">√ñva glosor</button>
                <button onclick="selectType('verb')">B√∂ja verb</button>
                <button onclick="selectType('flipcards')">üÉè FlipCards</button>
                <button onclick="selectType('spel')">üéÆ Spel</button>
            </div>
        </div>

        <div id="screen-game-menu" class="hidden">
            <h2>üéÆ V√§lj spel:</h2>
            <div class="button-group">
                <button onclick="goToBlockBlast()">üß± BlockBlast</button>
                <button onclick="goToRocketShips()">üöÄ Rocket Ships</button>
                <button onclick="goToMainMenu()">Tillbaka</button>
            </div>
        </div>

        <!-- BLOCKBLAST INPUT -->
        <div id="screen-blockblast-input" class="hidden">
            <h2>L√§gg in glosor f√∂r BlockBlast:</h2>
            <div class="button-group">
                <button onclick="exportBlockBlast()" class="small" style="background: #28a745;">üíæ Ladda ner fil</button>
                <button onclick="document.getElementById('import-blockblast').click()" class="small" style="background: #17a2b8;">üìÇ Ladda fil</button>
                <input type="file" id="import-blockblast" accept=".json" style="display: none;" onchange="importBlockBlast(event)">
            </div>
            <!-- IMAGE UPLOAD -->
            <div class="image-upload-section">
                <h4>üì∑ L√§gg in glosor fr√•n bild</h4>
                <label class="image-upload-label" for="img-blockblast">
                    üñºÔ∏è V√§lj bild
                </label>
                <input type="file" id="img-blockblast" accept="image/*" style="display:none;" onchange="handleImageSelect(event, 'blockblast')">
                <div class="image-upload-preview" id="preview-blockblast">
                    <img id="preview-img-blockblast" src="" alt="F√∂rhandsgranskning">
                    <div class="img-name" id="preview-name-blockblast"></div>
                </div>
                <button class="extract-btn" id="extract-btn-blockblast" onclick="extractFromImage('blockblast')">
                    ‚ú® H√§mta glosor fr√•n bild
                </button>
                <div class="extract-status" id="extract-status-blockblast"></div>
                <p>AI l√§ser av glosor automatiskt fr√•n bilden</p>
            </div>
            <div class="header-row">
                <div>Svenska</div>
                <div>Annat spr√•k</div>
                <div></div>
            </div>
            <div class="glos-input-container" id="blockblast-glos-container"></div>
            <div class="button-group">
                <button onclick="addBlockBlastGlosRow()" class="small">+ L√§gg till rad</button>
                <button onclick="startBlockBlastGame()">Starta spel</button>
                <button onclick="goBack('screen-game-menu')">Tillbaka</button>
            </div>
        </div>

        <div id="screen-blockblast" class="hidden">
            <h2>üß± BlockBlast</h2>
            <div class="game-info">
                <div>Po√§ng: <span id="game-score">0</span></div>
                <div>Bitar kvar: <span id="pieces-left">4</span></div>
            </div>
            
            <div class="game-board" id="game-board"></div>
            
            <div id="glos-question-container" class="hidden">
                <div class="glos-question-panel">
                    <h3>üéØ √ñvers√§tt f√∂r att f√• nya bitar!</h3>
                    <div class="word" id="glos-word"></div>
                    <input type="text" id="glos-answer" placeholder="Skriv ditt svar...">
                    <div class="button-group">
                        <button onclick="checkGlosAnswer()">Svara</button>
                    </div>
                    <div id="glos-feedback"></div>
                </div>
            </div>

            <div class="pieces-container" id="pieces-container"></div>
            
            <div class="button-group">
                <button onclick="goToMainMenu()">Avsluta</button>
            </div>
        </div>

        <!-- ROCKETSHIPS INPUT -->
        <div id="screen-rocketships-input" class="hidden">
            <h2>L√§gg in glosor f√∂r Rocket Ships:</h2>
            <div class="button-group">
                <button onclick="exportRocketShips()" class="small" style="background: #28a745;">üíæ Ladda ner fil</button>
                <button onclick="document.getElementById('import-rocketships').click()" class="small" style="background: #17a2b8;">üìÇ Ladda fil</button>
                <input type="file" id="import-rocketships" accept=".json" style="display: none;" onchange="importRocketShips(event)">
            </div>
            <!-- IMAGE UPLOAD -->
            <div class="image-upload-section">
                <h4>üì∑ L√§gg in glosor fr√•n bild</h4>
                <label class="image-upload-label" for="img-rocketships">
                    üñºÔ∏è V√§lj bild
                </label>
                <input type="file" id="img-rocketships" accept="image/*" style="display:none;" onchange="handleImageSelect(event, 'rocketships')">
                <div class="image-upload-preview" id="preview-rocketships">
                    <img id="preview-img-rocketships" src="" alt="F√∂rhandsgranskning">
                    <div class="img-name" id="preview-name-rocketships"></div>
                </div>
                <button class="extract-btn" id="extract-btn-rocketships" onclick="extractFromImage('rocketships')">
                    ‚ú® H√§mta glosor fr√•n bild
                </button>
                <div class="extract-status" id="extract-status-rocketships"></div>
                <p>AI l√§ser av glosor automatiskt fr√•n bilden</p>
            </div>
            <div class="header-row">
                <div>Svenska</div>
                <div>Annat spr√•k</div>
                <div></div>
            </div>
            <div class="glos-input-container" id="rocketships-glos-container"></div>
            <div class="button-group">
                <button onclick="addRocketShipsGlosRow()" class="small">+ L√§gg till rad</button>
                <button onclick="startRocketShipsGame()">Starta spel</button>
                <button onclick="goBack('screen-game-menu')">Tillbaka</button>
            </div>
        </div>

        <div id="screen-rocketships" class="hidden">
            <h2>üöÄ Rocket Ships</h2>
            <div class="game-info">
                <div>Liv: <span id="rocket-lives">3</span> ‚ù§Ô∏è</div>
                <div>V√•g: <span id="rocket-wave">1</span></div>
                <div>Po√§ng: <span id="rocket-score">0</span></div>
            </div>
            
            <canvas id="rocket-canvas" width="800" height="600"></canvas>
            
            <div class="mobile-controls" id="mobile-controls">
                <button class="control-btn up" id="btn-up">‚Üë</button>
                <button class="control-btn left" id="btn-left">‚Üê</button>
                <button class="control-btn down" id="btn-down">‚Üì</button>
                <button class="control-btn right" id="btn-right">‚Üí</button>
                <button class="control-btn pause" id="btn-pause">PAUSA</button>
            </div>
            
            <div class="controls-info">
                <strong>Desktop:</strong> W/‚Üë = Upp | S/‚Üì = Ner | A/‚Üê = V√§nster | D/‚Üí = H√∂ger | SPACE = Pausa
            </div>
            
            <div id="rocket-question-container" class="hidden">
                <div class="glos-question-panel">
                    <h3>üéØ √ñvers√§tt f√∂r att forts√§tta till n√§sta v√•g!</h3>
                    <div class="word" id="rocket-glos-word"></div>
                    <input type="text" id="rocket-glos-answer" placeholder="Skriv ditt svar...">
                    <div class="button-group">
                        <button onclick="checkRocketGlosAnswer()">Svara</button>
                    </div>
                    <div id="rocket-glos-feedback"></div>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="goToMainMenu()">Avsluta</button>
            </div>
        </div>

        <!-- FLIPCARDS INPUT -->
        <div id="screen-flipcards-input" class="hidden">
            <h2>L√§gg in glosor f√∂r FlipCards:</h2>
            <div class="button-group">
                <button onclick="exportFlipCards()" class="small" style="background: #28a745;">üíæ Ladda ner fil</button>
                <button onclick="document.getElementById('import-flipcards').click()" class="small" style="background: #17a2b8;">üìÇ Ladda fil</button>
                <input type="file" id="import-flipcards" accept=".json" style="display: none;" onchange="importFlipCards(event)">
            </div>
            <!-- IMAGE UPLOAD -->
            <div class="image-upload-section">
                <h4>üì∑ L√§gg in glosor fr√•n bild</h4>
                <label class="image-upload-label" for="img-flipcards">
                    üñºÔ∏è V√§lj bild
                </label>
                <input type="file" id="img-flipcards" accept="image/*" style="display:none;" onchange="handleImageSelect(event, 'flipcards')">
                <div class="image-upload-preview" id="preview-flipcards">
                    <img id="preview-img-flipcards" src="" alt="F√∂rhandsgranskning">
                    <div class="img-name" id="preview-name-flipcards"></div>
                </div>
                <button class="extract-btn" id="extract-btn-flipcards" onclick="extractFromImage('flipcards')">
                    ‚ú® H√§mta glosor fr√•n bild
                </button>
                <div class="extract-status" id="extract-status-flipcards"></div>
                <p>AI l√§ser av glosor automatiskt fr√•n bilden</p>
            </div>
            <div class="header-row">
                <div>Svenska</div>
                <div>Annat spr√•k</div>
                <div></div>
            </div>
            <div class="glos-input-container" id="flipcards-glos-container"></div>
            <div class="button-group">
                <button onclick="addFlipCardsGlosRow()" class="small">+ L√§gg till rad</button>
                <button onclick="startFlipCardsGame()">Starta FlipCards</button>
                <button onclick="goBack('screen-main-menu')">Tillbaka</button>
            </div>
        </div>

        <div id="screen-flipcards" class="hidden">
            <h2>üÉè FlipCards</h2>
            <div class="progress">
                Kort <span id="flipcard-current">1</span> av <span id="flipcard-total">0</span>
            </div>
            
            <div class="flipcard-container">
                <div class="flipcard" id="flipcard" onclick="flipCard()">
                    <div class="flipcard-inner" id="flipcard-inner">
                        <div class="flipcard-front">
                            <div id="flipcard-front-text"></div>
                        </div>
                        <div class="flipcard-back">
                            <div id="flipcard-back-text"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 15px 0; color: #666; font-size: 0.9em;">
                Klicka p√• kortet f√∂r att v√§nda det!
            </div>
            
            <div class="button-group">
                <button onclick="markCard('known')" style="background: #28a745;">‚úì Kunde</button>
                <button onclick="markCard('unknown')" style="background: #dc3545;">‚úó Kunde inte</button>
                <button onclick="nextCard()">N√§sta ‚Üí</button>
            </div>
            
            <div id="flipcard-complete" class="hidden" style="text-align: center; margin-top: 30px;">
                <h2 style="color: #28a745;">üéâ Klart!</h2>
                <div style="font-size: 1.2em; margin: 20px 0;">
                    <div style="color: #28a745; margin: 10px 0;">Kunde: <span id="flipcard-known-count">0</span></div>
                    <div style="color: #dc3545; margin: 10px 0;">Kunde inte: <span id="flipcard-unknown-count">0</span></div>
                </div>
                <div class="button-group" id="flipcard-buttons">
                    <button onclick="restartFlipCards('mistakes')">üîÑ √ñva misstag</button>
                    <button onclick="restartFlipCards('all')">üîÑ Starta om alla</button>
                    <button onclick="goToMainMenu()">Tillbaka till meny</button>
                </div>
            </div>
        </div>

        <!-- GLOSOR INPUT -->
        <div id="screen-input-glosor" class="hidden">
            <h2>L√§gg in dina glosor:</h2>
            <div class="button-group">
                <button onclick="exportGlosor()" class="small" style="background: #28a745;">üíæ Ladda ner fil</button>
                <button onclick="document.getElementById('import-glosor').click()" class="small" style="background: #17a2b8;">üìÇ Ladda fil</button>
                <input type="file" id="import-glosor" accept=".json" style="display: none;" onchange="importGlosor(event)">
            </div>
            <!-- IMAGE UPLOAD -->
            <div class="image-upload-section">
                <h4>üì∑ L√§gg in glosor fr√•n bild</h4>
                <label class="image-upload-label" for="img-glosor">
                    üñºÔ∏è V√§lj bild
                </label>
                <input type="file" id="img-glosor" accept="image/*" style="display:none;" onchange="handleImageSelect(event, 'glosor')">
                <div class="image-upload-preview" id="preview-glosor">
                    <img id="preview-img-glosor" src="" alt="F√∂rhandsgranskning">
                    <div class="img-name" id="preview-name-glosor"></div>
                </div>
                <button class="extract-btn" id="extract-btn-glosor" onclick="extractFromImage('glosor')">
                    ‚ú® H√§mta glosor fr√•n bild
                </button>
                <div class="extract-status" id="extract-status-glosor"></div>
                <p>AI l√§ser av glosor automatiskt fr√•n bilden</p>
            </div>
            <div class="header-row">
                <div>Svenska</div>
                <div>Annat spr√•k</div>
                <div></div>
            </div>
            <div class="glos-input-container" id="glos-container"></div>
            <div class="button-group">
                <button onclick="addGlosRow()" class="small">+ L√§gg till rad</button>
                <button onclick="selectGlosDirection()">N√§sta</button>
                <button onclick="goToMainMenu()">Tillbaka</button>
            </div>
        </div>

        <div id="screen-glos-direction" class="hidden">
            <h2>V√§lj spr√•kl√§ge:</h2>
            <div class="button-group">
                <button onclick="startGlosTest('svenska')">Svenska ‚Üí Annat spr√•k</button>
                <button onclick="startGlosTest('spanska')">Annat spr√•k ‚Üí Svenska</button>
                <button onclick="goBack('screen-input-glosor')">Tillbaka</button>
            </div>
        </div>

        <div id="screen-input-verb" class="hidden">
            <h2>L√§gg in dina verb:</h2>
            <div class="button-group">
                <button onclick="exportVerb()" class="small" style="background: #28a745;">üíæ Ladda ner fil</button>
                <button onclick="document.getElementById('import-verb').click()" class="small" style="background: #17a2b8;">üìÇ Ladda fil</button>
                <input type="file" id="import-verb" accept=".json" style="display: none;" onchange="importVerb(event)">
            </div>
            <div id="verb-container"></div>
            <div class="button-group">
                <button onclick="addVerbForm()" class="small">+ L√§gg till verb</button>
                <button onclick="startVerbTest()">Starta test</button>
                <button onclick="goToMainMenu()">Tillbaka</button>
            </div>
        </div>

        <div id="screen-test" class="hidden">
            <div class="progress" id="progress"></div>
            <div class="word-panel" id="question"></div>
            <div id="answer-area"></div>
            <div class="button-group">
                <button onclick="checkAnswer()" id="btn-check">Svara</button>
                <button onclick="nextWord()" id="btn-next" class="hidden" style="background: #28a745;">N√§sta ‚Üí</button>
            </div>
            <div id="feedback"></div>
        </div>

        <div id="screen-result" class="hidden">
            <h2>‚úÖ Resultat</h2>
            <div class="score">
                <div class="score-correct">R√§tt: <span id="final-correct">0</span></div>
                <div class="score-wrong">Fel: <span id="final-wrong">0</span></div>
            </div>
            <div class="button-group">
                <button onclick="restartTest()">Starta om</button>
                <button id="btn-redo-mistakes" onclick="restartMistakes()" style="background: #dc3545;">üîÑ G√∂r om felen</button>
                <button onclick="goToMainMenu()">Meny</button>
            </div>
        </div>
    </div>

    <script>
        const labels = ["yo", "t√∫", "√©l/ella", "nosotros", "vosotros", "ellos/ellas"];
        let testType = null;
        let mode = null;
        let glosData = [];
        let verbData = [];
        let currentWords = [];
        let currentIndex = 0;
        let correct = 0;
        let wrong = 0;
        let attemptsLeft = 2;
        let correctFlags = [];
        let waitingForNext = false;
        let wrongWords = [];

        let gameGrid = [];
        let gameScore = 0;
        let currentPieces = [];
        let usedPieces = 0;
        let selectedPieceId = null;
        let blockBlastGlosData = [];
        let currentGlosIndex = 0;
        let glosMode = 'svenska';
        let blockBlastGlosAttempts = 0;

        let rocketCanvas, rocketCtx;
        let rocketPlayer, rocketEnemies, rocketBullets, rocketEnemyBullets;
        let rocketKeys = {};
        let rocketWave = 1;
        let rocketScore = 0;
        let rocketLives = 3;
        let rocketGameLoop;
        let rocketShootTimer = 0;
        let rocketGlosData = [];
        let rocketGlosIndex = 0;
        let rocketPaused = false;
        let rocketGameRunning = false;
        let rocketCountdown = 0;
        let rocketCountdownActive = false;
        let rocketGlosAttempts = 0;
        let rocketBonusEnemies = 0;

        let flipCardsData = [];
        let flipCardsOriginalData = [];
        let flipCardsCurrent = 0;
        let flipCardsKnown = [];
        let flipCardsUnknown = [];
        let flipCardsIsFlipped = false;

        // Image data store per section
        const imageDataStore = {};

        const pieceShapes = [
            [[1]], 
            [[1,1]], 
            [[1],[1]], 
            [[1,1,1]], 
            [[1],[1],[1]], 
            [[1,1],[1,1]], 
            [[1,1,1],[0,1,0]], 
            [[1,1,0],[0,1,1]], 
            [[1,0],[1,1]]
        ];

        // ===== IMAGE UPLOAD & EXTRACTION =====

        function handleImageSelect(event, section) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                // Store base64 data (strip the data:image/...;base64, prefix)
                const base64 = dataUrl.split(',')[1];
                const mimeType = file.type || 'image/jpeg';
                imageDataStore[section] = { base64, mimeType };

                // Show preview
                const preview = document.getElementById('preview-' + section);
                const previewImg = document.getElementById('preview-img-' + section);
                const previewName = document.getElementById('preview-name-' + section);
                preview.style.display = 'block';
                previewImg.src = dataUrl;
                previewName.textContent = file.name;

                // Show extract button
                const extractBtn = document.getElementById('extract-btn-' + section);
                extractBtn.style.display = 'inline-block';

                // Clear status
                const status = document.getElementById('extract-status-' + section);
                status.textContent = '';
                status.className = 'extract-status';
            };
            reader.readAsDataURL(file);
        }

        async function extractFromImage(section) {
            const stored = imageDataStore[section];
            if (!stored) return;

            const btn = document.getElementById('extract-btn-' + section);
            const status = document.getElementById('extract-status-' + section);

            btn.disabled = true;
            status.className = 'extract-status loading';
            status.innerHTML = '<span class="spinner"></span> AI analyserar bilden...';

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: [
                                {
                                    type: "image",
                                    source: {
                                        type: "base64",
                                        media_type: stored.mimeType,
                                        data: stored.base64
                                    }
                                },
                                {
                                    type: "text",
                                    text: `Look at this image. Find any vocabulary word pairs ‚Äî one column in Swedish (svenska) and one column in another language. Extract ALL pairs you can find.

Return ONLY a JSON array, nothing else, no markdown, no explanation. Format:
[{"svenska": "...", "spanska": "..."}, ...]

If you cannot find any vocabulary pairs in the image, return exactly: []`
                                }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const text = (data.content || []).map(b => b.text || '').join('');
                const clean = text.replace(/```json|```/g, '').trim();
                const pairs = JSON.parse(clean);

                if (!Array.isArray(pairs) || pairs.length === 0) {
                    status.className = 'extract-status error';
                    status.textContent = '‚ö†Ô∏è Inga glosor hittades i bilden.';
                } else {
                    populateGlosorFromImage(section, pairs);
                    status.className = 'extract-status success';
                    status.textContent = `‚úÖ ${pairs.length} glosor hittades och lades till!`;
                }
            } catch (err) {
                status.className = 'extract-status error';
                status.textContent = '‚ùå Fel vid analys. F√∂rs√∂k igen.';
                console.error(err);
            }

            btn.disabled = false;
        }

        function populateGlosorFromImage(section, pairs) {
            // Map section name to container id and row class/add function
            const config = {
                glosor:      { containerId: 'glos-container',             svClass: 'glos-sv',    esClass: 'glos-es',    addFn: addGlosRow },
                flipcards:   { containerId: 'flipcards-glos-container',   svClass: 'fc-glos-sv', esClass: 'fc-glos-es', addFn: addFlipCardsGlosRow },
                blockblast:  { containerId: 'blockblast-glos-container',  svClass: 'bb-glos-sv', esClass: 'bb-glos-es', addFn: addBlockBlastGlosRow },
                rocketships: { containerId: 'rocketships-glos-container', svClass: 'rs-glos-sv', esClass: 'rs-glos-es', addFn: addRocketShipsGlosRow }
            };

            const cfg = config[section];
            if (!cfg) return;

            const container = document.getElementById(cfg.containerId);

            // Find existing empty rows and fill them first, then add new ones
            const existingRows = container.querySelectorAll('.glos-row');
            let rowIndex = 0;

            // Fill existing empty rows
            existingRows.forEach(row => {
                if (rowIndex >= pairs.length) return;
                const svInput = row.querySelector('.' + cfg.svClass);
                const esInput = row.querySelector('.' + cfg.esClass);
                if (svInput && esInput && !svInput.value.trim() && !esInput.value.trim()) {
                    svInput.value = pairs[rowIndex].svenska || '';
                    esInput.value = pairs[rowIndex].spanska || '';
                    rowIndex++;
                }
            });

            // Add new rows for remaining pairs
            while (rowIndex < pairs.length) {
                cfg.addFn();
                const rows = container.querySelectorAll('.glos-row');
                const lastRow = rows[rows.length - 1];
                const svInput = lastRow.querySelector('.' + cfg.svClass);
                const esInput = lastRow.querySelector('.' + cfg.esClass);
                if (svInput && esInput) {
                    svInput.value = pairs[rowIndex].svenska || '';
                    esInput.value = pairs[rowIndex].spanska || '';
                }
                rowIndex++;
            }

            // Scroll to the container
            container.scrollTop = 0;
        }

        // ===== ORIGINAL FUNCTIONS (unchanged) =====

        function showScreen(screenId) {
            document.querySelectorAll('[id^="screen-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function selectType(type) {
            testType = type;
            if (type === 'glosor') {
                showScreen('screen-input-glosor');
                initializeGlosInput();
            } else if (type === 'verb') {
                showScreen('screen-input-verb');
                initializeVerbInput();
            } else if (type === 'spel') {
                showScreen('screen-game-menu');
            } else if (type === 'flipcards') {
                goToFlipCards();
            }
        }

        function goToMainMenu() {
            if (rocketGameRunning) {
                rocketGameRunning = false;
                if (rocketGameLoop) {
                    cancelAnimationFrame(rocketGameLoop);
                    rocketGameLoop = null;
                }
                document.removeEventListener('keydown', handleRocketKeyDown);
                document.removeEventListener('keyup', handleRocketKeyUp);
                removeMobileControls();
                rocketKeys = {};
                if (rocketCanvas && rocketCtx) {
                    rocketCtx.clearRect(0, 0, rocketCanvas.width, rocketCanvas.height);
                }
            }
            testType = null;
            mode = null;
            glosData = [];
            verbData = [];
            showScreen('screen-main-menu');
        }

        function goBack(screenId) {
            showScreen(screenId);
        }

        function goToBlockBlast() {
            showScreen('screen-blockblast-input');
            const container = document.getElementById('blockblast-glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                addBlockBlastGlosRow();
            }
        }

        function addBlockBlastGlosRow() {
            const container = document.getElementById('blockblast-glos-container');
            const row = document.createElement('div');
            row.className = 'glos-row';
            row.innerHTML = `
                <input type="text" placeholder="Svenskt ord" class="bb-glos-sv">
                <input type="text" placeholder="Annat spr√•k" class="bb-glos-es">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function startBlockBlastGame() {
            blockBlastGlosData = [];
            document.querySelectorAll('#blockblast-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.bb-glos-sv').value.trim();
                const es = row.querySelector('.bb-glos-es').value.trim();
                if (sv && es) {
                    blockBlastGlosData.push({ svenska: sv, spanska: es });
                }
            });
            if (blockBlastGlosData.length === 0) { alert('Du m√•ste l√§gga in minst en glos!'); return; }
            blockBlastGlosData.sort(() => Math.random() - 0.5);
            currentGlosIndex = 0;
            initializeGame();
            showScreen('screen-blockblast');
        }

        function initializeGame() {
            gameGrid = Array(8).fill().map(() => Array(8).fill(0));
            gameScore = 0;
            usedPieces = 0;
            selectedPieceId = null;
            updateGameScore();
            renderGrid();
            generateNewPieces();
        }

        function renderGrid() {
            const gridElement = document.getElementById('game-board');
            gridElement.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell' + (gameGrid[row][col] ? ' filled' : '');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.ondragover = (e) => {
                        e.preventDefault();
                        if (selectedPieceId !== null) {
                            const piece = currentPieces[selectedPieceId];
                            if (!piece.used) highlightDropZone(row, col, piece.shape);
                        }
                    };
                    cell.ondragleave = (e) => { clearHighlights(); };
                    cell.ondrop = (e) => { e.preventDefault(); placePiece(row, col); };
                    cell.onclick = () => placePiece(row, col);
                    gridElement.appendChild(cell);
                }
            }
        }

        function highlightDropZone(row, col, shape) {
            clearHighlights();
            const canPlace = canPlacePiece(shape, row, col);
            for (let r = 0; r < shape.length; r++) {
                for (let c = 0; c < shape[0].length; c++) {
                    if (shape[r][c]) {
                        const targetRow = row + r;
                        const targetCol = col + c;
                        if (targetRow < 8 && targetCol < 8) {
                            const cellElement = document.querySelector(`[data-row="${targetRow}"][data-col="${targetCol}"]`);
                            if (cellElement) cellElement.classList.add(canPlace ? 'valid-drop' : 'invalid-drop');
                        }
                    }
                }
            }
        }

        function generateNewPieces() {
            currentPieces = [];
            usedPieces = 0;
            selectedPieceId = null;
            const container = document.getElementById('pieces-container');
            container.innerHTML = '';
            const numPieces = (blockBlastGlosAttempts >= 2) ? 3 : 4;
            for (let i = 0; i < numPieces; i++) {
                const shape = pieceShapes[Math.floor(Math.random() * pieceShapes.length)];
                currentPieces.push({ shape, used: false, id: i });
                renderPiece(shape, i);
            }
            updatePiecesLeft();
        }

        function renderPiece(shape, id) {
            const container = document.getElementById('pieces-container');
            const pieceDiv = document.createElement('div');
            pieceDiv.className = 'piece';
            pieceDiv.dataset.pieceId = id;
            pieceDiv.draggable = true;
            pieceDiv.style.gridTemplateColumns = `repeat(${shape[0].length}, 25px)`;
            pieceDiv.style.gridTemplateRows = `repeat(${shape.length}, 25px)`;
            shape.forEach(row => {
                row.forEach(cell => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'piece-cell' + (cell ? ' active' : '');
                    pieceDiv.appendChild(cellDiv);
                });
            });
            pieceDiv.ondragstart = (e) => {
                if (currentPieces[id].used) { e.preventDefault(); return; }
                selectedPieceId = id;
                pieceDiv.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            };
            pieceDiv.ondragend = (e) => { pieceDiv.classList.remove('dragging'); clearHighlights(); };
            pieceDiv.onclick = () => selectPiece(id);
            container.appendChild(pieceDiv);
        }

        function selectPiece(id) {
            if (currentPieces[id].used) return;
            selectedPieceId = id;
            document.querySelectorAll('.piece').forEach(p => p.classList.remove('selected'));
            document.querySelector(`[data-piece-id="${id}"]`).classList.add('selected');
        }

        function clearHighlights() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('valid-drop', 'invalid-drop');
            });
        }

        function placePiece(row, col) {
            if (selectedPieceId === null) return;
            const piece = currentPieces[selectedPieceId];
            if (piece.used) return;
            if (canPlacePiece(piece.shape, row, col)) {
                for (let r = 0; r < piece.shape.length; r++) {
                    for (let c = 0; c < piece.shape[0].length; c++) {
                        if (piece.shape[r][c]) gameGrid[row + r][col + c] = 1;
                    }
                }
                piece.used = true;
                const pieceElement = document.querySelector(`[data-piece-id="${selectedPieceId}"]`);
                pieceElement.classList.add('used');
                pieceElement.draggable = false;
                usedPieces++;
                updatePiecesLeft();
                checkCompleteLines();
                renderGrid();
                clearHighlights();
                selectedPieceId = null;
                document.querySelectorAll('.piece').forEach(p => p.classList.remove('selected'));
                if (usedPieces === currentPieces.length) showGlosQuestion();
            }
        }

        function canPlacePiece(shape, row, col) {
            for (let r = 0; r < shape.length; r++) {
                for (let c = 0; c < shape[0].length; c++) {
                    if (shape[r][c]) {
                        if (row + r >= 8 || col + c >= 8 || gameGrid[row + r][col + c]) return false;
                    }
                }
            }
            return true;
        }

        function checkCompleteLines() {
            let linesCleared = 0;
            for (let row = 0; row < 8; row++) {
                if (gameGrid[row].every(cell => cell === 1)) { gameGrid[row].fill(0); linesCleared++; }
            }
            for (let col = 0; col < 8; col++) {
                let columnFull = true;
                for (let row = 0; row < 8; row++) { if (gameGrid[row][col] === 0) { columnFull = false; break; } }
                if (columnFull) { for (let row = 0; row < 8; row++) gameGrid[row][col] = 0; linesCleared++; }
            }
            if (linesCleared > 0) { gameScore += linesCleared * 10; updateGameScore(); }
        }

        function updateGameScore() { document.getElementById('game-score').textContent = gameScore; }
        function updatePiecesLeft() {
            document.getElementById('pieces-left').textContent = currentPieces.length - usedPieces;
        }

        function showGlosQuestion() {
            if (currentGlosIndex >= blockBlastGlosData.length) {
                currentGlosIndex = 0;
                blockBlastGlosData.sort(() => Math.random() - 0.5);
            }
            const glos = blockBlastGlosData[currentGlosIndex];
            const questionContainer = document.getElementById('glos-question-container');
            const wordElement = document.getElementById('glos-word');
            const answerInput = document.getElementById('glos-answer');
            glosMode = Math.random() < 0.5 ? 'svenska' : 'spanska';
            wordElement.textContent = glosMode === 'svenska' ? glos.svenska : glos.spanska;
            answerInput.value = '';
            document.getElementById('glos-feedback').innerHTML = '';
            blockBlastGlosAttempts = 0;
            questionContainer.classList.remove('hidden');
            answerInput.focus();
            answerInput.onkeypress = (e) => { if (e.key === 'Enter') checkGlosAnswer(); };
        }

        function checkGlosAnswer() {
            const glos = blockBlastGlosData[currentGlosIndex];
            const answer = document.getElementById('glos-answer').value.trim().toLowerCase();
            const correctAnswer = (glosMode === 'svenska' ? glos.spanska : glos.svenska).toLowerCase();
            const feedbackDiv = document.getElementById('glos-feedback');
            blockBlastGlosAttempts++;
            if (answer === correctAnswer) {
                feedbackDiv.innerHTML = '<div class="feedback correct">‚úÖ R√§tt! Du f√•r nya bitar!</div>';
                setTimeout(() => {
                    document.getElementById('glos-question-container').classList.add('hidden');
                    currentGlosIndex++;
                    generateNewPieces();
                }, 1500);
            } else if (blockBlastGlosAttempts >= 2) {
                feedbackDiv.innerHTML = `<div class="feedback wrong">‚ùå Fel 2 g√•nger! R√§tt svar: ${correctAnswer}<br><strong>‚ö†Ô∏è Straff: Bara 3 bitar n√§sta runda!</strong></div>`;
                setTimeout(() => {
                    document.getElementById('glos-question-container').classList.add('hidden');
                    currentGlosIndex++;
                    generateNewPieces();
                }, 2500);
            } else {
                feedbackDiv.innerHTML = '<div class="feedback wrong">‚ùå Fel, f√∂rs√∂k igen! (1 f√∂rs√∂k kvar)</div>';
            }
        }

        function goToRocketShips() {
            showScreen('screen-rocketships-input');
            const container = document.getElementById('rocketships-glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                addRocketShipsGlosRow();
            }
        }

        function addRocketShipsGlosRow() {
            const container = document.getElementById('rocketships-glos-container');
            const row = document.createElement('div');
            row.className = 'glos-row';
            row.innerHTML = `
                <input type="text" placeholder="Svenskt ord" class="rs-glos-sv">
                <input type="text" placeholder="Annat spr√•k" class="rs-glos-es">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function startRocketShipsGame() {
            rocketGlosData = [];
            document.querySelectorAll('#rocketships-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.rs-glos-sv').value.trim();
                const es = row.querySelector('.rs-glos-es').value.trim();
                if (sv && es) rocketGlosData.push({ svenska: sv, spanska: es });
            });
            if (rocketGlosData.length === 0) { alert('Du m√•ste l√§gga in minst en glos!'); return; }
            rocketGlosData.sort(() => Math.random() - 0.5);
            rocketGlosIndex = 0;
            initializeRocketGame();
            showScreen('screen-rocketships');
        }

        function initializeRocketGame() {
            rocketCanvas = document.getElementById('rocket-canvas');
            rocketCtx = rocketCanvas.getContext('2d');
            rocketWave = 1; rocketScore = 0; rocketLives = 3; rocketPaused = false;
            rocketGameRunning = true; rocketShootTimer = 0; rocketKeys = {};
            rocketGlosAttempts = 0; rocketBonusEnemies = 0;
            rocketPlayer = { x: 50, y: rocketCanvas.height / 2, width: 40, height: 30, speed: 5 };
            rocketBullets = []; rocketEnemyBullets = []; rocketEnemies = [];
            document.removeEventListener('keydown', handleRocketKeyDown);
            document.removeEventListener('keyup', handleRocketKeyUp);
            document.addEventListener('keydown', handleRocketKeyDown);
            document.addEventListener('keyup', handleRocketKeyUp);
            setupMobileControls();
            updateRocketUI();
            if (rocketGameLoop) cancelAnimationFrame(rocketGameLoop);
            rocketCountdown = 3; rocketCountdownActive = true;
            const countdownInterval = setInterval(() => {
                rocketCountdown--;
                if (rocketCountdown <= 0) { clearInterval(countdownInterval); rocketCountdownActive = false; spawnEnemyWave(); }
            }, 1000);
            gameLoopRocket();
        }

        function setupMobileControls() {
            const btnUp = document.getElementById('btn-up');
            const btnDown = document.getElementById('btn-down');
            const btnLeft = document.getElementById('btn-left');
            const btnRight = document.getElementById('btn-right');
            const btnPause = document.getElementById('btn-pause');
            btnUp.addEventListener('touchstart', (e) => { e.preventDefault(); rocketKeys['w'] = true; });
            btnUp.addEventListener('touchend', (e) => { e.preventDefault(); rocketKeys['w'] = false; });
            btnDown.addEventListener('touchstart', (e) => { e.preventDefault(); rocketKeys['s'] = true; });
            btnDown.addEventListener('touchend', (e) => { e.preventDefault(); rocketKeys['s'] = false; });
            btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); rocketKeys['a'] = true; });
            btnLeft.addEventListener('touchend', (e) => { e.preventDefault(); rocketKeys['a'] = false; });
            btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); rocketKeys['d'] = true; });
            btnRight.addEventListener('touchend', (e) => { e.preventDefault(); rocketKeys['d'] = false; });
            btnPause.addEventListener('touchstart', (e) => { e.preventDefault(); rocketPaused = !rocketPaused; });
            btnPause.addEventListener('click', (e) => { e.preventDefault(); rocketPaused = !rocketPaused; });
        }

        function removeMobileControls() {
            const btns = ['btn-up', 'btn-down', 'btn-left', 'btn-right', 'btn-pause'];
            btns.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                }
            });
        }

        function handleRocketKeyDown(e) {
            if (document.activeElement.tagName === 'INPUT') return;
            if (['w', 'a', 's', 'd', 'ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight', ' '].includes(e.key.toLowerCase())) e.preventDefault();
            if (e.key === ' ') { rocketPaused = !rocketPaused; return; }
            rocketKeys[e.key.toLowerCase()] = true;
        }

        function handleRocketKeyUp(e) {
            if (document.activeElement.tagName === 'INPUT') return;
            rocketKeys[e.key.toLowerCase()] = false;
        }

        function spawnEnemyWave() {
            rocketEnemies = [];
            if (rocketWave <= 3) {
                const baseEnemyCount = rocketWave * 5;
                const enemyCount = baseEnemyCount + rocketBonusEnemies;
                for (let i = 0; i < enemyCount; i++) {
                    rocketEnemies.push({
                        x: rocketCanvas.width - 100 - Math.random() * 150,
                        y: 50 + Math.random() * (rocketCanvas.height - 100),
                        width: 35, height: 35, speed: 1 + Math.random() * 0.5, health: 1,
                        shootTimer: Math.random() * 120,
                        movePattern: Math.random() < 0.5 ? 'circle' : 'wave',
                        angle: Math.random() * Math.PI * 2,
                        centerX: rocketCanvas.width * 0.7,
                        centerY: rocketCanvas.height / 2,
                        radius: 80 + Math.random() * 50
                    });
                }
            } else {
                rocketEnemies.push({
                    x: rocketCanvas.width - 150, y: rocketCanvas.height / 2 - 50,
                    width: 80, height: 80, speed: 1, health: 10, maxHealth: 10,
                    isBoss: true, shootTimer: 0, angle: 0,
                    centerX: rocketCanvas.width * 0.7, centerY: rocketCanvas.height / 2, radius: 60
                });
            }
            rocketBonusEnemies = 0;
        }

        function gameLoopRocket() {
            if (!rocketGameRunning) return;
            if (!rocketPaused) {
                updateRocket();
                drawRocket();
            } else {
                rocketCtx.fillStyle = 'rgba(0,0,0,0.5)';
                rocketCtx.fillRect(0, 0, rocketCanvas.width, rocketCanvas.height);
                rocketCtx.fillStyle = 'white';
                rocketCtx.font = '40px Arial';
                rocketCtx.textAlign = 'center';
                rocketCtx.fillText('PAUSAD', rocketCanvas.width / 2, rocketCanvas.height / 2);
                rocketCtx.font = '20px Arial';
                rocketCtx.fillText('Tryck SPACE/PAUSA', rocketCanvas.width / 2, rocketCanvas.height / 2 + 40);
            }
            rocketGameLoop = requestAnimationFrame(gameLoopRocket);
        }

        function updateRocket() {
            if (rocketKeys['w'] || rocketKeys['arrowup']) rocketPlayer.y -= rocketPlayer.speed;
            if (rocketKeys['s'] || rocketKeys['arrowdown']) rocketPlayer.y += rocketPlayer.speed;
            if (rocketKeys['a'] || rocketKeys['arrowleft']) rocketPlayer.x -= rocketPlayer.speed;
            if (rocketKeys['d'] || rocketKeys['arrowright']) rocketPlayer.x += rocketPlayer.speed;
            rocketPlayer.x = Math.max(0, Math.min(rocketCanvas.width - rocketPlayer.width, rocketPlayer.x));
            rocketPlayer.y = Math.max(0, Math.min(rocketCanvas.height - rocketPlayer.height, rocketPlayer.y));
            if (rocketCountdownActive) return;
            rocketShootTimer++;
            if (rocketShootTimer >= 60) {
                rocketBullets.push({ x: rocketPlayer.x + rocketPlayer.width, y: rocketPlayer.y + rocketPlayer.height / 2, width: 10, height: 4, speed: 8 });
                rocketShootTimer = 0;
            }
            rocketBullets.forEach(b => b.x += b.speed);
            rocketBullets = rocketBullets.filter(b => b.x < rocketCanvas.width);
            rocketEnemyBullets.forEach(b => { b.x += b.speedX; b.y += b.speedY; });
            rocketEnemyBullets = rocketEnemyBullets.filter(b => b.x > -20 && b.x < rocketCanvas.width + 20 && b.y > -20 && b.y < rocketCanvas.height + 20);
            rocketEnemies.forEach(e => {
                if (e.isBoss) {
                    e.angle += 0.02;
                    e.x = e.centerX + Math.cos(e.angle) * e.radius;
                    e.y = e.centerY + Math.sin(e.angle) * e.radius;
                } else {
                    if (e.movePattern === 'circle') {
                        e.angle += 0.03 * e.speed;
                        e.x = e.centerX + Math.cos(e.angle) * e.radius;
                        e.y = e.centerY + Math.sin(e.angle) * e.radius;
                    } else {
                        e.angle += 0.05 * e.speed;
                        e.y = e.centerY + Math.sin(e.angle) * 60;
                        e.x = e.centerX + Math.cos(e.angle * 0.5) * 40;
                    }
                }
                e.x = Math.max(rocketCanvas.width * 0.4, Math.min(rocketCanvas.width - e.width - 20, e.x));
                e.y = Math.max(20, Math.min(rocketCanvas.height - e.height - 20, e.y));
                e.shootTimer++;
                const shootInterval = e.isBoss ? 30 : 90;
                if (e.shootTimer >= shootInterval) {
                    const dx = rocketPlayer.x - e.x;
                    const dy = rocketPlayer.y - e.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    rocketEnemyBullets.push({ x: e.x, y: e.y + e.height / 2, width: 8, height: 8, speedX: (dx / distance) * 3, speedY: (dy / distance) * 3 });
                    e.shootTimer = 0;
                }
            });
            rocketBullets.forEach((b, bIndex) => {
                rocketEnemies.forEach((e, eIndex) => {
                    if (b.x < e.x + e.width && b.x + b.width > e.x && b.y < e.y + e.height && b.y + b.height > e.y) {
                        rocketBullets.splice(bIndex, 1);
                        e.health--;
                        if (e.health <= 0) { rocketEnemies.splice(eIndex, 1); rocketScore += e.isBoss ? 50 : 10; updateRocketUI(); }
                    }
                });
            });
            rocketEnemyBullets.forEach((b, bIndex) => {
                if (b.x < rocketPlayer.x + rocketPlayer.width && b.x + b.width > rocketPlayer.x &&
                    b.y < rocketPlayer.y + rocketPlayer.height && b.y + b.height > rocketPlayer.y) {
                    rocketEnemyBullets.splice(bIndex, 1);
                    rocketLives--;
                    updateRocketUI();
                    if (rocketLives <= 0) gameOverRocket();
                }
            });
            if (rocketEnemies.length === 0) { rocketPaused = true; showRocketGlosQuestion(); }
        }

        function drawRocket() {
            rocketCtx.fillStyle = '#0a0a1a';
            rocketCtx.fillRect(0, 0, rocketCanvas.width, rocketCanvas.height);
            rocketCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            const time = Date.now() * 0.0001;
            for (let i = 0; i < 100; i++) {
                const x = ((i * 123 + time * 50) % rocketCanvas.width);
                const y = (i * 456 % rocketCanvas.height);
                const size = (i % 3) + 1;
                rocketCtx.fillRect(x, y, size, size);
            }
            rocketCtx.save();
            rocketCtx.shadowBlur = 20; rocketCtx.shadowColor = '#00ffff';
            const gradient = rocketCtx.createLinearGradient(rocketPlayer.x, rocketPlayer.y, rocketPlayer.x + rocketPlayer.width, rocketPlayer.y);
            gradient.addColorStop(0, '#00ccff'); gradient.addColorStop(1, '#00ffff');
            rocketCtx.fillStyle = gradient;
            rocketCtx.beginPath();
            rocketCtx.moveTo(rocketPlayer.x, rocketPlayer.y + rocketPlayer.height / 2);
            rocketCtx.lineTo(rocketPlayer.x + 10, rocketPlayer.y + 5);
            rocketCtx.lineTo(rocketPlayer.x + rocketPlayer.width - 5, rocketPlayer.y);
            rocketCtx.lineTo(rocketPlayer.x + rocketPlayer.width, rocketPlayer.y + rocketPlayer.height / 2);
            rocketCtx.lineTo(rocketPlayer.x + rocketPlayer.width - 5, rocketPlayer.y + rocketPlayer.height);
            rocketCtx.lineTo(rocketPlayer.x + 10, rocketPlayer.y + rocketPlayer.height - 5);
            rocketCtx.closePath(); rocketCtx.fill(); rocketCtx.restore();
            rocketCtx.save();
            rocketBullets.forEach(b => {
                rocketCtx.shadowBlur = 15; rocketCtx.shadowColor = '#ffff00'; rocketCtx.fillStyle = '#ffff00';
                rocketCtx.beginPath(); rocketCtx.arc(b.x, b.y, 5, 0, Math.PI * 2); rocketCtx.fill();
            });
            rocketCtx.restore();
            rocketCtx.save();
            rocketEnemyBullets.forEach(b => {
                rocketCtx.shadowBlur = 15; rocketCtx.shadowColor = '#ff0000'; rocketCtx.fillStyle = '#ff3333';
                rocketCtx.beginPath(); rocketCtx.arc(b.x, b.y, 5, 0, Math.PI * 2); rocketCtx.fill();
            });
            rocketCtx.restore();
            rocketCtx.save();
            rocketEnemies.forEach(e => {
                if (e.isBoss) {
                    rocketCtx.shadowBlur = 30; rocketCtx.shadowColor = '#ff00ff';
                    const bg = rocketCtx.createRadialGradient(e.x + e.width/2, e.y + e.height/2, 10, e.x + e.width/2, e.y + e.height/2, e.width/2);
                    bg.addColorStop(0, '#ff00ff'); bg.addColorStop(1, '#8800ff');
                    rocketCtx.fillStyle = bg;
                    rocketCtx.beginPath(); rocketCtx.arc(e.x + e.width/2, e.y + e.height/2, e.width/2, 0, Math.PI * 2); rocketCtx.fill();
                } else {
                    rocketCtx.shadowBlur = 15; rocketCtx.shadowColor = '#ff0000';
                    const eg = rocketCtx.createRadialGradient(e.x + e.width/2, e.y + e.height/2, 5, e.x + e.width/2, e.y + e.height/2, e.width/2);
                    eg.addColorStop(0, '#ff6666'); eg.addColorStop(1, '#ff0000');
                    rocketCtx.fillStyle = eg;
                    rocketCtx.beginPath();
                    rocketCtx.moveTo(e.x + e.width, e.y + e.height/2);
                    rocketCtx.lineTo(e.x + e.width/2, e.y);
                    rocketCtx.lineTo(e.x, e.y + e.height/2);
                    rocketCtx.lineTo(e.x + e.width/2, e.y + e.height);
                    rocketCtx.closePath(); rocketCtx.fill();
                }
            });
            rocketCtx.restore();
            if (rocketCountdownActive && rocketCountdown > 0) {
                rocketCtx.save();
                rocketCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                rocketCtx.fillRect(0, 0, rocketCanvas.width, rocketCanvas.height);
                rocketCtx.shadowBlur = 30; rocketCtx.shadowColor = '#00ffff'; rocketCtx.fillStyle = '#00ffff';
                rocketCtx.font = 'bold 120px Arial'; rocketCtx.textAlign = 'center';
                rocketCtx.fillText(rocketCountdown, rocketCanvas.width/2, rocketCanvas.height/2 + 40);
                rocketCtx.shadowBlur = 0; rocketCtx.fillStyle = '#ffffff';
                rocketCtx.font = 'bold 30px Arial';
                rocketCtx.fillText('V√ÖG ' + rocketWave, rocketCanvas.width/2, rocketCanvas.height/2 - 60);
                rocketCtx.restore();
            }
        }

        function updateRocketUI() {
            document.getElementById('rocket-lives').textContent = rocketLives;
            document.getElementById('rocket-wave').textContent = rocketWave;
            document.getElementById('rocket-score').textContent = rocketScore;
        }

        function showRocketGlosQuestion() {
            if (rocketGlosIndex >= rocketGlosData.length) { rocketGlosIndex = 0; rocketGlosData.sort(() => Math.random() - 0.5); }
            const glos = rocketGlosData[rocketGlosIndex];
            const questionContainer = document.getElementById('rocket-question-container');
            const wordElement = document.getElementById('rocket-glos-word');
            const answerInput = document.getElementById('rocket-glos-answer');
            const mode = Math.random() < 0.5 ? 'svenska' : 'spanska';
            wordElement.textContent = mode === 'svenska' ? glos.svenska : glos.spanska;
            wordElement.dataset.mode = mode;
            answerInput.value = '';
            document.getElementById('rocket-glos-feedback').innerHTML = '';
            rocketGlosAttempts = 0;
            questionContainer.classList.remove('hidden');
            answerInput.focus();
            answerInput.onkeypress = (e) => { if (e.key === 'Enter') checkRocketGlosAnswer(); };
        }

        function checkRocketGlosAnswer() {
            const glos = rocketGlosData[rocketGlosIndex];
            const answer = document.getElementById('rocket-glos-answer').value.trim().toLowerCase();
            const mode = document.getElementById('rocket-glos-word').dataset.mode;
            const correctAnswer = (mode === 'svenska' ? glos.spanska : glos.svenska).toLowerCase();
            const feedbackDiv = document.getElementById('rocket-glos-feedback');
            rocketGlosAttempts++;
            if (answer === correctAnswer) {
                feedbackDiv.innerHTML = '<div class="feedback correct">‚úÖ R√§tt! N√§sta v√•g startar!</div>';
                setTimeout(() => {
                    document.getElementById('rocket-question-container').classList.add('hidden');
                    rocketGlosIndex++;
                    rocketWave++; if (rocketWave > 4) rocketWave = 1;
                    updateRocketUI();
                    rocketEnemies = []; rocketEnemyBullets = []; rocketKeys = {};
                    rocketCountdown = 3; rocketCountdownActive = true; rocketPaused = false;
                    const ci = setInterval(() => { rocketCountdown--; if (rocketCountdown <= 0) { clearInterval(ci); rocketCountdownActive = false; spawnEnemyWave(); } }, 1000);
                }, 1500);
            } else if (rocketGlosAttempts >= 2) {
                rocketBonusEnemies = 1;
                feedbackDiv.innerHTML = `<div class="feedback wrong">‚ùå Fel 2 g√•nger! R√§tt svar: ${correctAnswer}<br><strong>‚ö†Ô∏è Straff: +1 extra fiende n√§sta v√•g!</strong></div>`;
                setTimeout(() => {
                    document.getElementById('rocket-question-container').classList.add('hidden');
                    rocketGlosIndex++;
                    rocketWave++; if (rocketWave > 4) rocketWave = 1;
                    updateRocketUI();
                    rocketEnemies = []; rocketEnemyBullets = []; rocketKeys = {};
                    rocketCountdown = 3; rocketCountdownActive = true; rocketPaused = false;
                    const ci = setInterval(() => { rocketCountdown--; if (rocketCountdown <= 0) { clearInterval(ci); rocketCountdownActive = false; spawnEnemyWave(); } }, 1000);
                }, 2500);
            } else {
                feedbackDiv.innerHTML = '<div class="feedback wrong">‚ùå Fel, f√∂rs√∂k igen! (1 f√∂rs√∂k kvar)</div>';
            }
        }

        function gameOverRocket() {
            rocketGameRunning = false; rocketPaused = true;
            if (rocketGameLoop) { cancelAnimationFrame(rocketGameLoop); rocketGameLoop = null; }
            document.removeEventListener('keydown', handleRocketKeyDown);
            document.removeEventListener('keyup', handleRocketKeyUp);
            removeMobileControls(); rocketKeys = {};
            alert(`Game Over! üí•\n\nDin slutpo√§ng: ${rocketScore}\nV√•gor klarade: ${rocketWave - 1}`);
            goToMainMenu();
        }

        function goToFlipCards() {
            showScreen('screen-flipcards-input');
            const container = document.getElementById('flipcards-glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) { addFlipCardsGlosRow(); }
        }

        function addFlipCardsGlosRow() {
            const container = document.getElementById('flipcards-glos-container');
            const row = document.createElement('div');
            row.className = 'glos-row';
            row.innerHTML = `
                <input type="text" placeholder="Svenskt ord" class="fc-glos-sv">
                <input type="text" placeholder="Annat spr√•k" class="fc-glos-es">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function startFlipCardsGame() {
            flipCardsData = [];
            document.querySelectorAll('#flipcards-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.fc-glos-sv').value.trim();
                const es = row.querySelector('.fc-glos-es').value.trim();
                if (sv && es) flipCardsData.push({ svenska: sv, spanska: es });
            });
            if (flipCardsData.length === 0) { alert('Du m√•ste l√§gga in minst en glos!'); return; }
            flipCardsOriginalData = [...flipCardsData];
            flipCardsData.sort(() => Math.random() - 0.5);
            flipCardsCurrent = 0; flipCardsKnown = []; flipCardsUnknown = [];
            showScreen('screen-flipcards');
            document.getElementById('flipcard-complete').classList.add('hidden');
            displayFlipCard();
        }

        function displayFlipCard() {
            if (flipCardsCurrent >= flipCardsData.length) { showFlipCardComplete(); return; }
            const card = flipCardsData[flipCardsCurrent];
            flipCardsIsFlipped = false;
            document.getElementById('flipcard-inner').classList.remove('flipped');
            document.getElementById('flipcard-front-text').textContent = card.svenska;
            document.getElementById('flipcard-back-text').textContent = card.spanska;
            document.getElementById('flipcard-current').textContent = flipCardsCurrent + 1;
            document.getElementById('flipcard-total').textContent = flipCardsData.length;
        }

        function flipCard() {
            flipCardsIsFlipped = !flipCardsIsFlipped;
            const inner = document.getElementById('flipcard-inner');
            if (flipCardsIsFlipped) { inner.classList.add('flipped'); } else { inner.classList.remove('flipped'); }
        }

        function markCard(status) {
            const card = flipCardsData[flipCardsCurrent];
            if (status === 'known') { flipCardsKnown.push(card); } else { flipCardsUnknown.push(card); }
            nextCard();
        }

        function nextCard() { flipCardsCurrent++; displayFlipCard(); }

        function showFlipCardComplete() {
            document.getElementById('flipcard').style.display = 'none';
            document.querySelector('#screen-flipcards .button-group:not(#flipcard-buttons)').style.display = 'none';
            document.getElementById('flipcard-complete').classList.remove('hidden');
            document.getElementById('flipcard-known-count').textContent = flipCardsKnown.length;
            document.getElementById('flipcard-unknown-count').textContent = flipCardsUnknown.length;
        }

        function restartFlipCards(mode) {
            if (mode === 'mistakes') {
                if (flipCardsUnknown.length === 0) { alert('Inga misstag att √∂va p√•! Du kunde alla! üéâ'); return; }
                flipCardsData = [...flipCardsUnknown];
            } else {
                flipCardsData = [...flipCardsOriginalData];
            }
            flipCardsData.sort(() => Math.random() - 0.5);
            flipCardsCurrent = 0; flipCardsKnown = []; flipCardsUnknown = [];
            document.getElementById('flipcard').style.display = 'block';
            document.querySelector('#screen-flipcards .button-group:not(#flipcard-buttons)').style.display = 'flex';
            document.getElementById('flipcard-complete').classList.add('hidden');
            displayFlipCard();
        }

        function initializeGlosInput() {
            const container = document.getElementById('glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) { addGlosRow(); }
        }

        function addGlosRow() {
            const container = document.getElementById('glos-container');
            const row = document.createElement('div');
            row.className = 'glos-row';
            row.innerHTML = `
                <input type="text" placeholder="Svenskt ord" class="glos-sv">
                <input type="text" placeholder="Annat spr√•k" class="glos-es">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function selectGlosDirection() {
            glosData = [];
            document.querySelectorAll('#glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.glos-sv').value.trim();
                const es = row.querySelector('.glos-es').value.trim();
                if (sv && es) glosData.push({ svenska: sv, spanska: es });
            });
            if (glosData.length === 0) { alert('Du m√•ste l√§gga in minst en glos!'); return; }
            showScreen('screen-glos-direction');
        }

        function startGlosTest(direction) {
            mode = direction;
            currentWords = [...glosData];
            currentWords.sort(() => Math.random() - 0.5);
            currentIndex = 0; correct = 0; wrong = 0; attemptsLeft = 2; waitingForNext = false; wrongWords = [];
            showScreen('screen-test');
            displayQuestion();
        }

        function initializeVerbInput() {
            const container = document.getElementById('verb-container');
            container.innerHTML = '';
            for (let i = 0; i < 3; i++) { addVerbForm(); }
        }

        function addVerbForm() {
            const container = document.getElementById('verb-container');
            const formDiv = document.createElement('div');
            formDiv.className = 'verb-form';
            formDiv.innerHTML = `
                <label>Verb (grundform):</label>
                <input type="text" placeholder="t.ex. Ser, Hacer, etc." class="verb-name">
                <label>yo:</label>
                <input type="text" placeholder="t.ex. soy, hago" class="verb-yo">
                <label>t√∫:</label>
                <input type="text" placeholder="t.ex. eres, haces" class="verb-tu">
                <label>√©l/ella:</label>
                <input type="text" placeholder="t.ex. es, hace" class="verb-el">
                <label>nosotros:</label>
                <input type="text" placeholder="t.ex. somos, hacemos" class="verb-nosotros">
                <label>vosotros:</label>
                <input type="text" placeholder="t.ex. sois, hac√©is" class="verb-vosotros">
                <label>ellos/ellas:</label>
                <input type="text" placeholder="t.ex. son, hacen" class="verb-ellos">
                <button class="remove-btn" onclick="this.parentElement.remove()" style="margin-top: 10px; width: 100%;">Ta bort verb</button>
            `;
            container.appendChild(formDiv);
        }

        function startVerbTest() {
            verbData = [];
            document.querySelectorAll('.verb-form').forEach(form => {
                const name = form.querySelector('.verb-name').value.trim();
                const yo = form.querySelector('.verb-yo').value.trim();
                const tu = form.querySelector('.verb-tu').value.trim();
                const el = form.querySelector('.verb-el').value.trim();
                const nosotros = form.querySelector('.verb-nosotros').value.trim();
                const vosotros = form.querySelector('.verb-vosotros').value.trim();
                const ellos = form.querySelector('.verb-ellos').value.trim();
                if (name && yo && tu && el && nosotros && vosotros && ellos) {
                    verbData.push({ svenska: name, spanska: [yo, tu, el, nosotros, vosotros, ellos] });
                }
            });
            if (verbData.length === 0) { alert('Du m√•ste l√§gga in minst ett verb med alla b√∂jningar!'); return; }
            testType = 'verb';
            currentWords = [...verbData];
            currentWords.sort(() => Math.random() - 0.5);
            currentIndex = 0; correct = 0; wrong = 0; attemptsLeft = 2; waitingForNext = false; wrongWords = [];
            showScreen('screen-test');
            displayQuestion();
        }

        function displayQuestion() {
            if (currentIndex >= currentWords.length) { showResults(); return; }
            const item = currentWords[currentIndex];
            document.getElementById('progress').textContent = `Ord ${currentIndex + 1} av ${currentWords.length}`;
            document.getElementById('feedback').innerHTML = '';
            waitingForNext = false;
            document.getElementById('btn-check').classList.remove('hidden');
            document.getElementById('btn-next').classList.add('hidden');
            if (testType === 'glosor') {
                const displayWord = mode === 'svenska' ? item.svenska : item.spanska;
                document.getElementById('question').textContent = displayWord;
                document.getElementById('answer-area').innerHTML = `<input type="text" class="input-box" id="answer-input" placeholder="Skriv ditt svar h√§r...">`;
                document.getElementById('answer-input').focus();
                document.getElementById('answer-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') { if (waitingForNext) { nextWord(); } else { checkAnswer(); } }
                });
            } else if (testType === 'verb') {
                document.getElementById('question').textContent = item.svenska;
                let html = '';
                correctFlags = Array(6).fill(false);
                for (let i = 0; i < 6; i++) {
                    html += `<div class="irreg-input-row"><div class="irreg-label">${labels[i]} =</div><input type="text" class="input-box" id="input-${i}" placeholder="Skriv b√∂jningen..."></div>`;
                }
                document.getElementById('answer-area').innerHTML = html;
                document.getElementById('input-0').focus();
                for (let i = 0; i < 6; i++) {
                    document.getElementById(`input-${i}`).addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') { if (waitingForNext) { nextWord(); } else { checkAnswer(); } }
                    });
                }
            }
        }

        function showNextButton() {
            waitingForNext = true;
            document.getElementById('btn-check').classList.add('hidden');
            document.getElementById('btn-next').classList.remove('hidden');
        }

        function nextWord() { currentIndex++; attemptsLeft = 2; displayQuestion(); }

        function checkAnswer() {
            if (waitingForNext) return;
            const item = currentWords[currentIndex];
            const feedbackDiv = document.getElementById('feedback');
            if (testType === 'glosor') {
                const answer = document.getElementById('answer-input').value.trim().toLowerCase();
                const correctAnswer = (mode === 'svenska' ? item.spanska : item.svenska).toLowerCase();
                if (answer === correctAnswer) {
                    feedbackDiv.innerHTML = '<div class="feedback correct">‚úÖ R√§tt!</div>';
                    correct++;
                    showNextButton();
                } else {
                    attemptsLeft--;
                    if (attemptsLeft === 0) {
                        const displayCorrect = mode === 'svenska' ? item.spanska : item.svenska;
                        feedbackDiv.innerHTML = `<div class="feedback wrong">‚ùå Fel! R√§tt svar: ${displayCorrect}</div>`;
                        wrong++;
                        wrongWords.push(item);
                        showNextButton();
                    } else {
                        feedbackDiv.innerHTML = '<div class="feedback wrong">‚ùå Fel, f√∂rs√∂k igen!</div>';
                    }
                }
            } else if (testType === 'verb') {
                const correctForms = item.spanska.map(f => f.toLowerCase());
                let newlyCorrect = 0;
                let totalCorrect = 0;
                for (let i = 0; i < 6; i++) {
                    const input = document.getElementById(`input-${i}`);
                    const answer = input.value.trim().toLowerCase();
                    if (!correctFlags[i] && answer === correctForms[i]) {
                        correctFlags[i] = true; newlyCorrect++;
                        input.classList.add('correct'); input.disabled = true;
                    }
                    if (correctFlags[i]) totalCorrect++;
                }
                if (totalCorrect === 6) {
                    feedbackDiv.innerHTML = '<div class="feedback correct">‚úÖ R√§tt p√• alla b√∂jningar!</div>';
                    correct++;
                    showNextButton();
                } else {
                    attemptsLeft--;
                    if (attemptsLeft === 0) {
                        feedbackDiv.innerHTML = `<div class="feedback wrong">‚ùå Fel! R√§tt svar: ${item.spanska.join(', ')}</div>`;
                        wrong++;
                        wrongWords.push(item);
                        showNextButton();
                    } else {
                        if (newlyCorrect > 0) {
                            feedbackDiv.innerHTML = `<div class="feedback correct">‚úÖ ${newlyCorrect} nya r√§tt! Totalt ${totalCorrect}/6. F√∂rs√∂k igen!</div>`;
                        } else {
                            feedbackDiv.innerHTML = `<div class="feedback wrong">‚ùå Inga nya r√§tt. ${totalCorrect}/6 klara. F√∂rs√∂k igen!</div>`;
                        }
                        for (let i = 0; i < 6; i++) { if (!correctFlags[i]) document.getElementById(`input-${i}`).value = ''; }
                    }
                }
            }
        }

        function showResults() {
            document.getElementById('final-correct').textContent = correct;
            document.getElementById('final-wrong').textContent = wrong;
            const btn = document.getElementById('btn-redo-mistakes');
            btn.style.display = wrongWords.length > 0 ? '' : 'none';
            showScreen('screen-result');
        }

        function restartTest() {
            if (testType === 'glosor') { startGlosTest(mode); }
            else if (testType === 'verb') { startVerbTest(); }
        }

        function restartMistakes() {
            if (wrongWords.length === 0) return;
            currentWords = [...wrongWords];
            currentWords.sort(() => Math.random() - 0.5);
            currentIndex = 0; correct = 0; wrong = 0; attemptsLeft = 2; waitingForNext = false; wrongWords = [];
            showScreen('screen-test');
            displayQuestion();
        }

        // === EXPORT/IMPORT ===

        function exportGlosor() {
            const data = [];
            document.querySelectorAll('#glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.glos-sv').value.trim();
                const es = row.querySelector('.glos-es').value.trim();
                if (sv && es) data.push({ svenska: sv, spanska: es });
            });
            if (data.length === 0) { alert('Inga glosor att spara!'); return; }
            downloadJSON(data, 'glosor.json');
        }

        function importGlosor(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const container = document.getElementById('glos-container');
                    container.innerHTML = '';
                    data.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'glos-row';
                        row.innerHTML = `<input type="text" placeholder="Svenskt ord" class="glos-sv" value="${item.svenska}"><input type="text" placeholder="Annat spr√•k" class="glos-es" value="${item.spanska}"><button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>`;
                        container.appendChild(row);
                    });
                    alert(`‚úÖ ${data.length} glosor inl√§sta!`);
                } catch (error) { alert('‚ùå Kunde inte l√§sa filen.'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportVerb() {
            const data = [];
            document.querySelectorAll('.verb-form').forEach(form => {
                const name = form.querySelector('.verb-name').value.trim();
                const yo = form.querySelector('.verb-yo').value.trim();
                const tu = form.querySelector('.verb-tu').value.trim();
                const el = form.querySelector('.verb-el').value.trim();
                const nosotros = form.querySelector('.verb-nosotros').value.trim();
                const vosotros = form.querySelector('.verb-vosotros').value.trim();
                const ellos = form.querySelector('.verb-ellos').value.trim();
                if (name && yo && tu && el && nosotros && vosotros && ellos) {
                    data.push({ name, yo, tu, el, nosotros, vosotros, ellos });
                }
            });
            if (data.length === 0) { alert('Inga verb att spara!'); return; }
            downloadJSON(data, 'verb.json');
        }

        function importVerb(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const container = document.getElementById('verb-container');
                    container.innerHTML = '';
                    data.forEach(verb => {
                        const formDiv = document.createElement('div');
                        formDiv.className = 'verb-form';
                        formDiv.innerHTML = `
                            <label>Verb (grundform):</label><input type="text" class="verb-name" value="${verb.name}">
                            <label>yo:</label><input type="text" class="verb-yo" value="${verb.yo}">
                            <label>t√∫:</label><input type="text" class="verb-tu" value="${verb.tu}">
                            <label>√©l/ella:</label><input type="text" class="verb-el" value="${verb.el}">
                            <label>nosotros:</label><input type="text" class="verb-nosotros" value="${verb.nosotros}">
                            <label>vosotros:</label><input type="text" class="verb-vosotros" value="${verb.vosotros}">
                            <label>ellos/ellas:</label><input type="text" class="verb-ellos" value="${verb.ellos}">
                            <button class="remove-btn" onclick="this.parentElement.remove()" style="margin-top: 10px; width: 100%;">Ta bort verb</button>
                        `;
                        container.appendChild(formDiv);
                    });
                    alert(`‚úÖ ${data.length} verb inl√§sta!`);
                } catch (error) { alert('‚ùå Kunde inte l√§sa filen.'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportFlipCards() {
            const data = [];
            document.querySelectorAll('#flipcards-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.fc-glos-sv').value.trim();
                const es = row.querySelector('.fc-glos-es').value.trim();
                if (sv && es) data.push({ svenska: sv, spanska: es });
            });
            if (data.length === 0) { alert('Inga glosor att spara!'); return; }
            downloadJSON(data, 'flipcards.json');
        }

        function importFlipCards(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const container = document.getElementById('flipcards-glos-container');
                    container.innerHTML = '';
                    data.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'glos-row';
                        row.innerHTML = `<input type="text" placeholder="Svenskt ord" class="fc-glos-sv" value="${item.svenska}"><input type="text" placeholder="Annat spr√•k" class="fc-glos-es" value="${item.spanska}"><button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>`;
                        container.appendChild(row);
                    });
                    alert(`‚úÖ ${data.length} glosor inl√§sta!`);
                } catch (error) { alert('‚ùå Kunde inte l√§sa filen.'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportBlockBlast() {
            const data = [];
            document.querySelectorAll('#blockblast-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.bb-glos-sv').value.trim();
                const es = row.querySelector('.bb-glos-es').value.trim();
                if (sv && es) data.push({ svenska: sv, spanska: es });
            });
            if (data.length === 0) { alert('Inga glosor att spara!'); return; }
            downloadJSON(data, 'blockblast-glosor.json');
        }

        function importBlockBlast(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const container = document.getElementById('blockblast-glos-container');
                    container.innerHTML = '';
                    data.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'glos-row';
                        row.innerHTML = `<input type="text" placeholder="Svenskt ord" class="bb-glos-sv" value="${item.svenska}"><input type="text" placeholder="Annat spr√•k" class="bb-glos-es" value="${item.spanska}"><button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>`;
                        container.appendChild(row);
                    });
                    alert(`‚úÖ ${data.length} glosor inl√§sta!`);
                } catch (error) { alert('‚ùå Kunde inte l√§sa filen.'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportRocketShips() {
            const data = [];
            document.querySelectorAll('#rocketships-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.rs-glos-sv').value.trim();
                const es = row.querySelector('.rs-glos-es').value.trim();
                if (sv && es) data.push({ svenska: sv, spanska: es });
            });
            if (data.length === 0) { alert('Inga glosor att spara!'); return; }
            downloadJSON(data, 'rocketships-glosor.json');
        }

        function importRocketShips(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const container = document.getElementById('rocketships-glos-container');
                    container.innerHTML = '';
                    data.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'glos-row';
                        row.innerHTML = `<input type="text" placeholder="Svenskt ord" class="rs-glos-sv" value="${item.svenska}"><input type="text" placeholder="Annat spr√•k" class="rs-glos-es" value="${item.spanska}"><button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>`;
                        container.appendChild(row);
                    });
                    alert(`‚úÖ ${data.length} glosor inl√§sta!`);
                } catch (error) { alert('‚ùå Kunde inte l√§sa filen.'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert(`‚úÖ Fil sparad som ${filename}`);
        }
    </script>
</body>
</html>
