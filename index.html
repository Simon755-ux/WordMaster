<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glostest ‚Äì Spanska/Svenska</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button.small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .hidden {
            display: none;
        }

        /* Glosinmatning */
        .glos-input-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }

        .glos-row {
            display: grid;
            grid-template-columns: 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .glos-row input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .header-row {
            display: grid;
            grid-template-columns: 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #667eea;
        }

        /* Verb */
        .verb-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .verb-form input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .verb-form label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-top: 10px;
        }

        /* Test */
        .word-panel {
            background: #f5f5f5;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.8em;
            color: #333;
        }

        .input-box {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 3px solid #ddd;
            border-radius: 10px;
            margin: 10px 0;
        }

        .input-box.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .irreg-input-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 15px;
        }

        .irreg-label {
            min-width: 120px;
            font-weight: bold;
            color: #555;
        }

        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .feedback.wrong {
            background: #f8d7da;
            color: #721c24;
        }

        .progress {
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
            color: #555;
        }

        .score {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            font-size: 1.5em;
        }

        .score-correct {
            color: #28a745;
        }

        .score-wrong {
            color: #dc3545;
        }

        /* BlockBlast */
        .game-info {
            display: flex;
            justify-content: space-between;
            max-width: 500px;
            margin: 0 auto 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 50px);
            grid-template-rows: repeat(8, 50px);
            gap: 2px;
            background: #ddd;
            padding: 5px;
            border-radius: 10px;
            margin: 20px auto;
            width: fit-content;
        }

        .cell {
            width: 50px;
            height: 50px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .cell.filled {
            background: #667eea;
        }

        .cell:hover {
            background: #f0f0f0;
        }

        .cell.valid-drop {
            background: #b3e5b3 !important;
            border-color: #28a745;
        }

        .cell.invalid-drop {
            background: #ffb3b3 !important;
            border-color: #dc3545;
        }

        .pieces-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .piece {
            display: inline-grid;
            gap: 2px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            cursor: grab;
            transition: all 0.2s;
            border: 3px solid transparent;
            user-select: none;
        }

        .piece:active {
            cursor: grabbing;
        }

        .piece:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .piece.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .piece.selected {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .piece.used {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .piece-cell {
            width: 30px;
            height: 30px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .piece-cell.active {
            background: #667eea;
        }

        .glos-question-panel {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ffc107;
            margin: 20px 0;
        }

        .glos-question-panel h3 {
            color: #856404;
            margin-bottom: 15px;
            text-align: center;
        }

        .glos-question-panel .word {
            font-size: 1.8em;
            text-align: center;
            margin: 15px 0;
            color: #333;
        }

        .glos-question-panel input {
            width: 100%;
            max-width: 400px;
            display: block;
            margin: 15px auto;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }

        /* FlipCards */
        .flipcard-container {
            perspective: 1000px;
            display: flex;
            justify-content: center;
            margin: 40px 0;
        }

        .flipcard {
            width: 500px;
            height: 300px;
            cursor: pointer;
        }

        .flipcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flipcard-inner.flipped {
            transform: rotateY(180deg);
        }

        .flipcard-front, .flipcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 40px;
            text-align: center;
        }

        .flipcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flipcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üá™üá∏ Glostest ‚Äì Spanska/Svenska</h1>
        
        <!-- Huvudmeny -->
        <div id="screen-main-menu">
            <h2>V√§lj vad du vill g√∂ra:</h2>
            <div class="button-group">
                <button onclick="selectType('glosor')">√ñva glosor</button>
                <button onclick="selectType('verb')">B√∂ja verb</button>
                <button onclick="selectType('flipcards')">üÉè FlipCards</button>
                <button onclick="selectType('spel')">üéÆ Spel</button>
            </div>
        </div>

        <!-- Spelmeny -->
        <div id="screen-game-menu" class="hidden">
            <h2>üéÆ V√§lj spel:</h2>
            <div class="button-group">
                <button onclick="goToBlockBlast()">üß± BlockBlast</button>
                <button onclick="goToRocketShips()">üöÄ Rocket Ships</button>
                <button onclick="goToMainMenu()">Tillbaka</button>
            </div>
        </div>

        <!-- BlockBlast glosinmatning -->
        <div id="screen-blockblast-input" class="hidden">
            <h2>L√§gg in glosor f√∂r BlockBlast:</h2>
            <div class="header-row">
                <div>Svenska</div>
                <div>Spanska</div>
                <div></div>
            </div>
            <div class="glos-input-container" id="blockblast-glos-container"></div>
            <div class="button-group">
                <button onclick="addBlockBlastGlosRow()" class="small">+ L√§gg till rad</button>
                <button onclick="startBlockBlastGame()">Starta spel</button>
                <button onclick="goBack('screen-game-menu')">Tillbaka</button>
            </div>
        </div>

        <!-- BlockBlast spel -->
        <div id="screen-blockblast" class="hidden">
            <h2>üß± BlockBlast</h2>
            <div class="game-info">
                <div>Po√§ng: <span id="game-score">0</span></div>
                <div>Bitar kvar: <span id="pieces-left">4</span></div>
            </div>
            
            <div class="game-board" id="game-board"></div>
            
            <div id="glos-question-container" class="hidden">
                <div class="glos-question-panel">
                    <h3>üéØ √ñvers√§tt f√∂r att f√• nya bitar!</h3>
                    <div class="word" id="glos-word"></div>
                    <input type="text" id="glos-answer" placeholder="Skriv ditt svar...">
                    <div class="button-group">
                        <button onclick="checkGlosAnswer()">Svara</button>
                    </div>
                    <div id="glos-feedback"></div>
                </div>
            </div>

            <div class="pieces-container" id="pieces-container"></div>
            
            <div class="button-group">
                <button onclick="goToMainMenu()">Avsluta</button>
            </div>
        </div>

        <!-- RocketShips glosinmatning -->
        <div id="screen-rocketships-input" class="hidden">
            <h2>L√§gg in glosor f√∂r Rocket Ships:</h2>
            <div class="header-row">
                <div>Svenska</div>
                <div>Spanska</div>
                <div></div>
            </div>
            <div class="glos-input-container" id="rocketships-glos-container"></div>
            <div class="button-group">
                <button onclick="addRocketShipsGlosRow()" class="small">+ L√§gg till rad</button>
                <button onclick="startRocketShipsGame()">Starta spel</button>
                <button onclick="goBack('screen-game-menu')">Tillbaka</button>
            </div>
        </div>

        <!-- RocketShips spel -->
        <div id="screen-rocketships" class="hidden">
            <h2>üöÄ Rocket Ships</h2>
            <div class="game-info">
                <div>Liv: <span id="rocket-lives">3</span> ‚ù§Ô∏è</div>
                <div>V√•g: <span id="rocket-wave">1</span></div>
                <div>Po√§ng: <span id="rocket-score">0</span></div>
            </div>
            
            <canvas id="rocket-canvas" width="800" height="600" style="border: 3px solid #667eea; border-radius: 10px; background: #000; display: block; margin: 20px auto;"></canvas>
            
            <div style="text-align: center; margin: 20px 0; color: #666;">
                <strong>Kontroller:</strong> W/‚Üë = Upp | S/‚Üì = Ner | A/‚Üê = V√§nster | D/‚Üí = H√∂ger | SPACE = Pausa
            </div>
            
            <div id="rocket-question-container" class="hidden">
                <div class="glos-question-panel">
                    <h3>üéØ √ñvers√§tt f√∂r att forts√§tta till n√§sta v√•g!</h3>
                    <div class="word" id="rocket-glos-word"></div>
                    <input type="text" id="rocket-glos-answer" placeholder="Skriv ditt svar...">
                    <div class="button-group">
                        <button onclick="checkRocketGlosAnswer()">Svara</button>
                    </div>
                    <div id="rocket-glos-feedback"></div>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="goToMainMenu()">Avsluta</button>
            </div>
        </div>

        <!-- FlipCards glosinmatning -->
        <div id="screen-flipcards-input" class="hidden">
            <h2>L√§gg in glosor f√∂r FlipCards:</h2>
            <div class="header-row">
                <div>Svenska</div>
                <div>Spanska</div>
                <div></div>
            </div>
            <div class="glos-input-container" id="flipcards-glos-container"></div>
            <div class="button-group">
                <button onclick="addFlipCardsGlosRow()" class="small">+ L√§gg till rad</button>
                <button onclick="startFlipCardsGame()">Starta FlipCards</button>
                <button onclick="goBack('screen-game-menu')">Tillbaka</button>
            </div>
        </div>

        <!-- FlipCards spel -->
        <div id="screen-flipcards" class="hidden">
            <h2>üÉè FlipCards</h2>
            <div class="progress" style="font-size: 1.3em; margin: 20px 0;">
                Kort <span id="flipcard-current">1</span> av <span id="flipcard-total">0</span>
            </div>
            
            <div class="flipcard-container">
                <div class="flipcard" id="flipcard" onclick="flipCard()">
                    <div class="flipcard-inner" id="flipcard-inner">
                        <div class="flipcard-front">
                            <div id="flipcard-front-text"></div>
                        </div>
                        <div class="flipcard-back">
                            <div id="flipcard-back-text"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0; color: #666;">
                Klicka p√• kortet f√∂r att v√§nda det!
            </div>
            
            <div class="button-group">
                <button onclick="markCard('known')" style="background: #28a745;">‚úì Kunde</button>
                <button onclick="markCard('unknown')" style="background: #dc3545;">‚úó Kunde inte</button>
                <button onclick="nextCard()">N√§sta ‚Üí</button>
            </div>
            
            <div id="flipcard-complete" class="hidden" style="text-align: center; margin-top: 30px;">
                <h2 style="color: #28a745;">üéâ Klart!</h2>
                <div style="font-size: 1.3em; margin: 20px 0;">
                    <div style="color: #28a745; margin: 10px 0;">Kunde: <span id="flipcard-known-count">0</span></div>
                    <div style="color: #dc3545; margin: 10px 0;">Kunde inte: <span id="flipcard-unknown-count">0</span></div>
                </div>
                <div class="button-group" id="flipcard-buttons">
                    <button onclick="restartFlipCards('mistakes')">üîÑ √ñva misstag</button>
                    <button onclick="restartFlipCards('all')">üîÑ Starta om alla</button>
                    <button onclick="goToMainMenu()">Tillbaka till meny</button>
                </div>
            </div>
        </div>

        <!-- L√§gg in glosor -->
        <div id="screen-input-glosor" class="hidden">
            <h2>L√§gg in dina glosor:</h2>
            <div class="header-row">
                <div>Svenska</div>
                <div>Spanska</div>
                <div></div>
            </div>
            <div class="glos-input-container" id="glos-container"></div>
            <div class="button-group">
                <button onclick="addGlosRow()" class="small">+ L√§gg till rad</button>
                <button onclick="selectGlosDirection()">N√§sta</button>
                <button onclick="goToMainMenu()">Tillbaka</button>
            </div>
        </div>

        <!-- V√§lj riktning f√∂r glosor -->
        <div id="screen-glos-direction" class="hidden">
            <h2>V√§lj spr√•kl√§ge:</h2>
            <div class="button-group">
                <button onclick="startGlosTest('svenska')">Svenska ‚Üí Spanska</button>
                <button onclick="startGlosTest('spanska')">Spanska ‚Üí Svenska</button>
                <button onclick="goBack('screen-input-glosor')">Tillbaka</button>
            </div>
        </div>

        <!-- L√§gg in verb -->
        <div id="screen-input-verb" class="hidden">
            <h2>L√§gg in dina verb:</h2>
            <div id="verb-container"></div>
            <div class="button-group">
                <button onclick="addVerbForm()" class="small">+ L√§gg till verb</button>
                <button onclick="startVerbTest()">Starta test</button>
                <button onclick="goToMainMenu()">Tillbaka</button>
            </div>
        </div>

        <!-- Test -->
        <div id="screen-test" class="hidden">
            <div class="progress" id="progress"></div>
            <div class="word-panel" id="question"></div>
            <div id="answer-area"></div>
            <div class="button-group">
                <button onclick="checkAnswer()">Svara</button>
            </div>
            <div id="feedback"></div>
        </div>

        <!-- Resultat -->
        <div id="screen-result" class="hidden">
            <h2>‚úÖ Resultat</h2>
            <div class="score">
                <div class="score-correct">R√§tt: <span id="final-correct">0</span></div>
                <div class="score-wrong">Fel: <span id="final-wrong">0</span></div>
            </div>
            <div class="button-group">
                <button onclick="restartTest()">Starta om</button>
                <button onclick="goToMainMenu()">Meny</button>
            </div>
        </div>
    </div>

    <script>
        // Globala variabler
        const labels = ["yo", "t√∫", "√©l/ella", "nosotros", "vosotros", "ellos/ellas"];
        let testType = null;
        let mode = null;
        let glosData = [];
        let verbData = [];
        let currentWords = [];
        let currentIndex = 0;
        let correct = 0;
        let wrong = 0;
        let attemptsLeft = 2;
        let correctFlags = [];

        // BlockBlast variabler
        let gameGrid = [];
        let gameScore = 0;
        let currentPieces = [];
        let usedPieces = 0;
        let selectedPieceId = null;
        let blockBlastGlosData = [];
        let currentGlosIndex = 0;
        let glosMode = 'svenska';

        // RocketShips variabler
        let rocketCanvas, rocketCtx;
        let rocketPlayer, rocketEnemies, rocketBullets, rocketEnemyBullets;
        let rocketKeys = {};
        let rocketWave = 1;
        let rocketScore = 0;
        let rocketLives = 3;
        let rocketGameLoop;
        let rocketShootTimer = 0;
        let rocketGlosData = [];
        let rocketGlosIndex = 0;
        let rocketPaused = false;
        let rocketGameRunning = false;
        let rocketCountdown = 0;
        let rocketCountdownActive = false;

        // FlipCards variabler
        let flipCardsData = [];
        let flipCardsOriginalData = [];
        let flipCardsCurrent = 0;
        let flipCardsKnown = [];
        let flipCardsUnknown = [];
        let flipCardsIsFlipped = false;

        const pieceShapes = [
            [[1]], 
            [[1,1]], 
            [[1],[1]], 
            [[1,1,1]], 
            [[1],[1],[1]], 
            [[1,1],[1,1]], 
            [[1,1,1],[0,1,0]], 
            [[1,1,0],[0,1,1]], 
            [[1,0],[1,1]]
        ];

        // Visa sk√§rm
        function showScreen(screenId) {
            document.querySelectorAll('[id^="screen-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        // V√§lj typ
        function selectType(type) {
            testType = type;
            if (type === 'glosor') {
                showScreen('screen-input-glosor');
                initializeGlosInput();
            } else if (type === 'verb') {
                showScreen('screen-input-verb');
                initializeVerbInput();
            } else if (type === 'spel') {
                showScreen('screen-game-menu');
            } else if (type === 'flipcards') {
                goToFlipCards();
            }
        }

        // Navigering
        function goToMainMenu() {
            // Stop rocket game if running
            if (rocketGameRunning) {
                rocketGameRunning = false;
                if (rocketGameLoop) {
                    cancelAnimationFrame(rocketGameLoop);
                    rocketGameLoop = null;
                }
                document.removeEventListener('keydown', handleRocketKeyDown);
                document.removeEventListener('keyup', handleRocketKeyUp);
                rocketKeys = {};
                
                // Clear canvas
                if (rocketCanvas && rocketCtx) {
                    rocketCtx.clearRect(0, 0, rocketCanvas.width, rocketCanvas.height);
                }
            }
            
            testType = null;
            mode = null;
            glosData = [];
            verbData = [];
            showScreen('screen-main-menu');
        }

        function goBack(screenId) {
            showScreen(screenId);
        }

        // === BLOCKBLAST ===
        function goToBlockBlast() {
            showScreen('screen-blockblast-input');
            const container = document.getElementById('blockblast-glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                addBlockBlastGlosRow();
            }
        }

        // === ROCKETSHIPS ===
        function goToRocketShips() {
            showScreen('screen-rocketships-input');
            const container = document.getElementById('rocketships-glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                addRocketShipsGlosRow();
            }
        }

        // === FLIPCARDS ===
        function goToFlipCards() {
            showScreen('screen-flipcards-input');
            const container = document.getElementById('flipcards-glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                addFlipCardsGlosRow();
            }
        }

        function addFlipCardsGlosRow() {
            const container = document.getElementById('flipcards-glos-container');
            const row = document.createElement('div');
            row.className = 'glos-row';
            row.innerHTML = `
                <input type="text" placeholder="Svenskt ord" class="fc-glos-sv">
                <input type="text" placeholder="Spanskt ord" class="fc-glos-es">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function startFlipCardsGame() {
            flipCardsData = [];
            document.querySelectorAll('#flipcards-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.fc-glos-sv').value.trim();
                const es = row.querySelector('.fc-glos-es').value.trim();
                if (sv && es) {
                    flipCardsData.push({ svenska: sv, spanska: es });
                }
            });

            if (flipCardsData.length === 0) {
                alert('Du m√•ste l√§gga in minst en glos!');
                return;
            }

            flipCardsOriginalData = [...flipCardsData];
            flipCardsData.sort(() => Math.random() - 0.5);
            flipCardsCurrent = 0;
            flipCardsKnown = [];
            flipCardsUnknown = [];
            
            showScreen('screen-flipcards');
            document.getElementById('flipcard-complete').classList.add('hidden');
            displayFlipCard();
        }

        function displayFlipCard() {
            if (flipCardsCurrent >= flipCardsData.length) {
                showFlipCardComplete();
                return;
            }

            const card = flipCardsData[flipCardsCurrent];
            flipCardsIsFlipped = false;
            
            document.getElementById('flipcard-inner').classList.remove('flipped');
            document.getElementById('flipcard-front-text').textContent = card.svenska;
            document.getElementById('flipcard-back-text').textContent = card.spanska;
            document.getElementById('flipcard-current').textContent = flipCardsCurrent + 1;
            document.getElementById('flipcard-total').textContent = flipCardsData.length;
        }

        function flipCard() {
            flipCardsIsFlipped = !flipCardsIsFlipped;
            const inner = document.getElementById('flipcard-inner');
            if (flipCardsIsFlipped) {
                inner.classList.add('flipped');
            } else {
                inner.classList.remove('flipped');
            }
        }

        function markCard(status) {
            const card = flipCardsData[flipCardsCurrent];
            
            if (status === 'known') {
                flipCardsKnown.push(card);
            } else {
                flipCardsUnknown.push(card);
            }
            
            nextCard();
        }

        function nextCard() {
            flipCardsCurrent++;
            displayFlipCard();
        }

        function showFlipCardComplete() {
            document.getElementById('flipcard').style.display = 'none';
            document.querySelector('#screen-flipcards .button-group:not(#flipcard-buttons)').style.display = 'none';
            document.getElementById('flipcard-complete').classList.remove('hidden');
            document.getElementById('flipcard-known-count').textContent = flipCardsKnown.length;
            document.getElementById('flipcard-unknown-count').textContent = flipCardsUnknown.length;
        }

        function restartFlipCards(mode) {
            if (mode === 'mistakes') {
                if (flipCardsUnknown.length === 0) {
                    alert('Inga misstag att √∂va p√•! Du kunde alla! üéâ');
                    return;
                }
                flipCardsData = [...flipCardsUnknown];
            } else {
                flipCardsData = [...flipCardsOriginalData];
            }
            
            flipCardsData.sort(() => Math.random() - 0.5);
            flipCardsCurrent = 0;
            flipCardsKnown = [];
            flipCardsUnknown = [];
            
            document.getElementById('flipcard').style.display = 'block';
            document.querySelector('#screen-flipcards .button-group:not(#flipcard-buttons)').style.display = 'flex';
            document.getElementById('flipcard-complete').classList.add('hidden');
            displayFlipCard();
        }

        // === ROCKETSHIPS FORTS√ÑTTNING ===

        function addRocketShipsGlosRow() {
            const container = document.getElementById('rocketships-glos-container');
            const row = document.createElement('div');
            row.className = 'glos-row';
            row.innerHTML = `
                <input type="text" placeholder="Svenskt ord" class="rs-glos-sv">
                <input type="text" placeholder="Spanskt ord" class="rs-glos-es">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function startRocketShipsGame() {
            rocketGlosData = [];
            document.querySelectorAll('#rocketships-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.rs-glos-sv').value.trim();
                const es = row.querySelector('.rs-glos-es').value.trim();
                if (sv && es) {
                    rocketGlosData.push({ svenska: sv, spanska: es });
                }
            });

            if (rocketGlosData.length === 0) {
                alert('Du m√•ste l√§gga in minst en glos!');
                return;
            }

            rocketGlosData.sort(() => Math.random() - 0.5);
            rocketGlosIndex = 0;
            initializeRocketGame();
            showScreen('screen-rocketships');
        }

        function initializeRocketGame() {
            rocketCanvas = document.getElementById('rocket-canvas');
            rocketCtx = rocketCanvas.getContext('2d');
            
            // Reset all game state
            rocketWave = 1;
            rocketScore = 0;
            rocketLives = 3;
            rocketPaused = false;
            rocketGameRunning = true;
            rocketShootTimer = 0;
            rocketKeys = {};
            
            rocketPlayer = {
                x: 50,
                y: rocketCanvas.height / 2,
                width: 40,
                height: 30,
                speed: 5
            };
            
            rocketBullets = [];
            rocketEnemyBullets = [];
            rocketEnemies = [];
            
            // Clear any existing event listeners
            document.removeEventListener('keydown', handleRocketKeyDown);
            document.removeEventListener('keyup', handleRocketKeyUp);
            
            // Add new event listeners
            document.addEventListener('keydown', handleRocketKeyDown);
            document.addEventListener('keyup', handleRocketKeyUp);
            
            updateRocketUI();
            
            // Cancel any existing game loop
            if (rocketGameLoop) {
                cancelAnimationFrame(rocketGameLoop);
            }
            
            // Start countdown before spawning enemies
            rocketCountdown = 3;
            rocketCountdownActive = true;
            
            const countdownInterval = setInterval(() => {
                rocketCountdown--;
                if (rocketCountdown <= 0) {
                    clearInterval(countdownInterval);
                    rocketCountdownActive = false;
                    spawnEnemyWave();
                }
            }, 1000);
            
            // Start new game loop
            gameLoopRocket();
        }

        function handleRocketKeyDown(e) {
            // Ignorera tangenttryckningar om anv√§ndaren skriver i input-f√§lt
            if (document.activeElement.tagName === 'INPUT') {
                return;
            }
            
            if (['w', 'a', 's', 'd', 'ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight', ' '].includes(e.key.toLowerCase())) {
                e.preventDefault();
            }
            
            if (e.key === ' ') {
                rocketPaused = !rocketPaused;
                return;
            }
            
            rocketKeys[e.key.toLowerCase()] = true;
        }

        function handleRocketKeyUp(e) {
            // Ignorera tangenttryckningar om anv√§ndaren skriver i input-f√§lt
            if (document.activeElement.tagName === 'INPUT') {
                return;
            }
            
            rocketKeys[e.key.toLowerCase()] = false;
        }

        function spawnEnemyWave() {
            rocketEnemies = [];
            let enemyCount;
            
            if (rocketWave <= 3) {
                enemyCount = rocketWave * 5;
                
                for (let i = 0; i < enemyCount; i++) {
                    rocketEnemies.push({
                        x: rocketCanvas.width - 100 - Math.random() * 150,
                        y: 50 + Math.random() * (rocketCanvas.height - 100),
                        width: 35,
                        height: 35,
                        speed: 1 + Math.random() * 0.5,
                        health: 1,
                        shootTimer: Math.random() * 120,
                        movePattern: Math.random() < 0.5 ? 'circle' : 'wave',
                        angle: Math.random() * Math.PI * 2,
                        centerX: rocketCanvas.width * 0.7,
                        centerY: rocketCanvas.height / 2,
                        radius: 80 + Math.random() * 50
                    });
                }
            } else {
                // Boss wave
                rocketEnemies.push({
                    x: rocketCanvas.width - 150,
                    y: rocketCanvas.height / 2 - 50,
                    width: 80,
                    height: 80,
                    speed: 1,
                    health: 10,
                    maxHealth: 10,
                    isBoss: true,
                    shootTimer: 0,
                    angle: 0,
                    centerX: rocketCanvas.width * 0.7,
                    centerY: rocketCanvas.height / 2,
                    radius: 60
                });
            }
        }

        function gameLoopRocket() {
            if (!rocketGameRunning) return;
            
            if (!rocketPaused) {
                updateRocket();
                drawRocket();
            } else {
                rocketCtx.fillStyle = 'rgba(0,0,0,0.5)';
                rocketCtx.fillRect(0, 0, rocketCanvas.width, rocketCanvas.height);
                rocketCtx.fillStyle = 'white';
                rocketCtx.font = '40px Arial';
                rocketCtx.textAlign = 'center';
                rocketCtx.fillText('PAUSAD', rocketCanvas.width / 2, rocketCanvas.height / 2);
                rocketCtx.font = '20px Arial';
                rocketCtx.fillText('Tryck SPACE f√∂r att forts√§tta', rocketCanvas.width / 2, rocketCanvas.height / 2 + 40);
            }
            
            rocketGameLoop = requestAnimationFrame(gameLoopRocket);
        }

        function updateRocket() {
            // Move player (kan alltid r√∂ra sig, √§ven under countdown)
            if (rocketKeys['w'] || rocketKeys['arrowup']) rocketPlayer.y -= rocketPlayer.speed;
            if (rocketKeys['s'] || rocketKeys['arrowdown']) rocketPlayer.y += rocketPlayer.speed;
            if (rocketKeys['a'] || rocketKeys['arrowleft']) rocketPlayer.x -= rocketPlayer.speed;
            if (rocketKeys['d'] || rocketKeys['arrowright']) rocketPlayer.x += rocketPlayer.speed;
            
            rocketPlayer.x = Math.max(0, Math.min(rocketCanvas.width - rocketPlayer.width, rocketPlayer.x));
            rocketPlayer.y = Math.max(0, Math.min(rocketCanvas.height - rocketPlayer.height, rocketPlayer.y));
            
            // Under countdown - visa bara countdown och l√•t spelaren r√∂ra sig
            if (rocketCountdownActive) {
                return;
            }
            
            // Auto shoot
            rocketShootTimer++;
            if (rocketShootTimer >= 60) {
                rocketBullets.push({
                    x: rocketPlayer.x + rocketPlayer.width,
                    y: rocketPlayer.y + rocketPlayer.height / 2,
                    width: 10,
                    height: 4,
                    speed: 8
                });
                rocketShootTimer = 0;
            }
            
            // Move bullets
            rocketBullets.forEach(b => b.x += b.speed);
            rocketBullets = rocketBullets.filter(b => b.x < rocketCanvas.width);
            
            // Move enemy bullets
            rocketEnemyBullets.forEach(b => {
                b.x += b.speedX;
                b.y += b.speedY;
            });
            rocketEnemyBullets = rocketEnemyBullets.filter(b => 
                b.x > -20 && b.x < rocketCanvas.width + 20 && 
                b.y > -20 && b.y < rocketCanvas.height + 20
            );
            
            // Move enemies
            rocketEnemies.forEach(e => {
                if (e.isBoss) {
                    // Boss circular movement
                    e.angle += 0.02;
                    e.x = e.centerX + Math.cos(e.angle) * e.radius;
                    e.y = e.centerY + Math.sin(e.angle) * e.radius;
                } else {
                    // Different movement patterns for regular enemies
                    if (e.movePattern === 'circle') {
                        e.angle += 0.03 * e.speed;
                        e.x = e.centerX + Math.cos(e.angle) * e.radius;
                        e.y = e.centerY + Math.sin(e.angle) * e.radius;
                    } else {
                        // Wave pattern
                        e.angle += 0.05 * e.speed;
                        e.y = e.centerY + Math.sin(e.angle) * 60;
                        e.x = e.centerX + Math.cos(e.angle * 0.5) * 40;
                    }
                }
                
                // Keep enemies in bounds
                e.x = Math.max(rocketCanvas.width * 0.4, Math.min(rocketCanvas.width - e.width - 20, e.x));
                e.y = Math.max(20, Math.min(rocketCanvas.height - e.height - 20, e.y));
                
                // Enemy shooting
                e.shootTimer++;
                const shootInterval = e.isBoss ? 30 : 90;
                if (e.shootTimer >= shootInterval) {
                    // Shoot towards player
                    const dx = rocketPlayer.x - e.x;
                    const dy = rocketPlayer.y - e.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const bulletSpeed = 3;
                    
                    rocketEnemyBullets.push({
                        x: e.x,
                        y: e.y + e.height / 2,
                        width: 8,
                        height: 8,
                        speedX: (dx / distance) * bulletSpeed,
                        speedY: (dy / distance) * bulletSpeed
                    });
                    e.shootTimer = 0;
                }
            });
            
            // Collision: Player bullets with enemies
            rocketBullets.forEach((b, bIndex) => {
                rocketEnemies.forEach((e, eIndex) => {
                    if (b.x < e.x + e.width && b.x + b.width > e.x &&
                        b.y < e.y + e.height && b.y + b.height > e.y) {
                        rocketBullets.splice(bIndex, 1);
                        e.health--;
                        if (e.health <= 0) {
                            rocketEnemies.splice(eIndex, 1);
                            rocketScore += e.isBoss ? 50 : 10;
                            updateRocketUI();
                        }
                    }
                });
            });
            
            // Collision: Enemy bullets with player
            rocketEnemyBullets.forEach((b, bIndex) => {
                if (b.x < rocketPlayer.x + rocketPlayer.width && b.x + b.width > rocketPlayer.x &&
                    b.y < rocketPlayer.y + rocketPlayer.height && b.y + b.height > rocketPlayer.y) {
                    rocketEnemyBullets.splice(bIndex, 1);
                    rocketLives--;
                    updateRocketUI();
                    if (rocketLives <= 0) {
                        gameOverRocket();
                    }
                }
            });
            
            // Check if wave cleared
            if (rocketEnemies.length === 0) {
                rocketPaused = true;
                showRocketGlosQuestion();
            }
        }

        function drawRocket() {
            // Background - animated starfield
            rocketCtx.fillStyle = '#0a0a1a';
            rocketCtx.fillRect(0, 0, rocketCanvas.width, rocketCanvas.height);
            
            // Animated stars
            rocketCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            const time = Date.now() * 0.0001;
            for (let i = 0; i < 100; i++) {
                const x = ((i * 123 + time * 50) % rocketCanvas.width);
                const y = (i * 456 % rocketCanvas.height);
                const size = (i % 3) + 1;
                rocketCtx.fillRect(x, y, size, size);
            }
            
            // Draw player - sleek spaceship
            rocketCtx.save();
            rocketCtx.shadowBlur = 20;
            rocketCtx.shadowColor = '#00ffff';
            
            // Main body (cyan/turquoise gradient)
            const gradient = rocketCtx.createLinearGradient(rocketPlayer.x, rocketPlayer.y, rocketPlayer.x + rocketPlayer.width, rocketPlayer.y);
            gradient.addColorStop(0, '#00ccff');
            gradient.addColorStop(1, '#00ffff');
            rocketCtx.fillStyle = gradient;
            
            rocketCtx.beginPath();
            rocketCtx.moveTo(rocketPlayer.x, rocketPlayer.y + rocketPlayer.height / 2);
            rocketCtx.lineTo(rocketPlayer.x + 10, rocketPlayer.y + 5);
            rocketCtx.lineTo(rocketPlayer.x + rocketPlayer.width - 5, rocketPlayer.y);
            rocketCtx.lineTo(rocketPlayer.x + rocketPlayer.width, rocketPlayer.y + rocketPlayer.height / 2);
            rocketCtx.lineTo(rocketPlayer.x + rocketPlayer.width - 5, rocketPlayer.y + rocketPlayer.height);
            rocketCtx.lineTo(rocketPlayer.x + 10, rocketPlayer.y + rocketPlayer.height - 5);
            rocketCtx.closePath();
            rocketCtx.fill();
            
            // Cockpit window
            rocketCtx.shadowBlur = 10;
            rocketCtx.fillStyle = '#ffffff';
            rocketCtx.beginPath();
            rocketCtx.arc(rocketPlayer.x + rocketPlayer.width - 12, rocketPlayer.y + rocketPlayer.height / 2, 7, 0, Math.PI * 2);
            rocketCtx.fill();
            
            // Engine glow
            rocketCtx.shadowBlur = 25;
            rocketCtx.shadowColor = '#00ffff';
            rocketCtx.fillStyle = 'rgba(0, 255, 255, 0.6)';
            rocketCtx.beginPath();
            rocketCtx.moveTo(rocketPlayer.x, rocketPlayer.y + rocketPlayer.height / 2);
            rocketCtx.lineTo(rocketPlayer.x - 10, rocketPlayer.y + rocketPlayer.height / 2 - 8);
            rocketCtx.lineTo(rocketPlayer.x - 10, rocketPlayer.y + rocketPlayer.height / 2 + 8);
            rocketCtx.closePath();
            rocketCtx.fill();
            
            rocketCtx.restore();
            
            // Draw bullets with trail effect
            rocketCtx.save();
            rocketBullets.forEach(b => {
                // Trail
                rocketCtx.shadowBlur = 15;
                rocketCtx.shadowColor = '#ffff00';
                const trailGradient = rocketCtx.createLinearGradient(b.x - 20, b.y, b.x, b.y);
                trailGradient.addColorStop(0, 'rgba(255, 255, 0, 0)');
                trailGradient.addColorStop(1, 'rgba(255, 255, 0, 0.8)');
                rocketCtx.fillStyle = trailGradient;
                rocketCtx.fillRect(b.x - 20, b.y - 2, 20, 4);
                
                // Bullet
                rocketCtx.fillStyle = '#ffff00';
                rocketCtx.beginPath();
                rocketCtx.arc(b.x, b.y, 5, 0, Math.PI * 2);
                rocketCtx.fill();
            });
            rocketCtx.restore();
            
            // Draw enemy bullets with glow
            rocketCtx.save();
            rocketEnemyBullets.forEach(b => {
                rocketCtx.shadowBlur = 15;
                rocketCtx.shadowColor = '#ff0000';
                rocketCtx.fillStyle = '#ff3333';
                rocketCtx.beginPath();
                rocketCtx.arc(b.x, b.y, 5, 0, Math.PI * 2);
                rocketCtx.fill();
            });
            rocketCtx.restore();
            
            // Draw enemies
            rocketCtx.save();
            rocketEnemies.forEach(e => {
                if (e.isBoss) {
                    // Epic boss design
                    rocketCtx.shadowBlur = 30;
                    rocketCtx.shadowColor = '#ff00ff';
                    
                    // Boss main body
                    const bossGradient = rocketCtx.createRadialGradient(
                        e.x + e.width / 2, e.y + e.height / 2, 10,
                        e.x + e.width / 2, e.y + e.height / 2, e.width / 2
                    );
                    bossGradient.addColorStop(0, '#ff00ff');
                    bossGradient.addColorStop(1, '#8800ff');
                    rocketCtx.fillStyle = bossGradient;
                    
                    rocketCtx.beginPath();
                    rocketCtx.arc(e.x + e.width / 2, e.y + e.height / 2, e.width / 2, 0, Math.PI * 2);
                    rocketCtx.fill();
                    
                    // Boss spikes
                    rocketCtx.fillStyle = '#ff00ff';
                    for (let i = 0; i < 8; i++) {
                        const angle = (Math.PI * 2 * i) / 8;
                        const x1 = e.x + e.width / 2 + Math.cos(angle) * (e.width / 2 - 5);
                        const y1 = e.y + e.height / 2 + Math.sin(angle) * (e.height / 2 - 5);
                        const x2 = e.x + e.width / 2 + Math.cos(angle) * (e.width / 2 + 15);
                        const y2 = e.y + e.height / 2 + Math.sin(angle) * (e.height / 2 + 15);
                        
                        rocketCtx.beginPath();
                        rocketCtx.moveTo(x1, y1);
                        rocketCtx.lineTo(x2, y2);
                        rocketCtx.lineWidth = 4;
                        rocketCtx.strokeStyle = '#ff00ff';
                        rocketCtx.stroke();
                    }
                    
                    // Boss eyes
                    rocketCtx.fillStyle = '#ffff00';
                    rocketCtx.shadowBlur = 10;
                    rocketCtx.shadowColor = '#ffff00';
                    rocketCtx.beginPath();
                    rocketCtx.arc(e.x + e.width / 2 - 15, e.y + e.height / 2, 8, 0, Math.PI * 2);
                    rocketCtx.arc(e.x + e.width / 2 + 15, e.y + e.height / 2, 8, 0, Math.PI * 2);
                    rocketCtx.fill();
                    
                    // Health bar
                    rocketCtx.shadowBlur = 0;
                    const barWidth = e.width + 20;
                    const barX = e.x - 10;
                    const barY = e.y - 25;
                    
                    rocketCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    rocketCtx.fillRect(barX, barY, barWidth, 12);
                    
                    rocketCtx.fillStyle = '#ff00ff';
                    rocketCtx.fillRect(barX + 2, barY + 2, ((e.health / e.maxHealth) * (barWidth - 4)), 8);
                    
                    rocketCtx.strokeStyle = '#ffffff';
                    rocketCtx.lineWidth = 2;
                    rocketCtx.strokeRect(barX, barY, barWidth, 12);
                    
                    rocketCtx.fillStyle = '#ffffff';
                    rocketCtx.font = 'bold 14px Arial';
                    rocketCtx.textAlign = 'center';
                    rocketCtx.fillText(`BOSS ${e.health}/${e.maxHealth}`, e.x + e.width / 2, barY - 5);
                } else {
                    // Regular enemy - alien design
                    rocketCtx.shadowBlur = 15;
                    rocketCtx.shadowColor = '#ff0000';
                    
                    const enemyGradient = rocketCtx.createRadialGradient(
                        e.x + e.width / 2, e.y + e.height / 2, 5,
                        e.x + e.width / 2, e.y + e.height / 2, e.width / 2
                    );
                    enemyGradient.addColorStop(0, '#ff6666');
                    enemyGradient.addColorStop(1, '#ff0000');
                    rocketCtx.fillStyle = enemyGradient;
                    
                    // Enemy body
                    rocketCtx.beginPath();
                    rocketCtx.moveTo(e.x + e.width, e.y + e.height / 2);
                    rocketCtx.lineTo(e.x + e.width / 2, e.y);
                    rocketCtx.lineTo(e.x, e.y + e.height / 2);
                    rocketCtx.lineTo(e.x + e.width / 2, e.y + e.height);
                    rocketCtx.closePath();
                    rocketCtx.fill();
                    
                    // Enemy eye
                    rocketCtx.shadowBlur = 8;
                    rocketCtx.shadowColor = '#00ff00';
                    rocketCtx.fillStyle = '#00ff00';
                    rocketCtx.beginPath();
                    rocketCtx.arc(e.x + e.width / 2, e.y + e.height / 2, 6, 0, Math.PI * 2);
                    rocketCtx.fill();
                }
            });
            rocketCtx.restore();
            
            // Draw countdown if active
            if (rocketCountdownActive && rocketCountdown > 0) {
                rocketCtx.save();
                rocketCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                rocketCtx.fillRect(0, 0, rocketCanvas.width, rocketCanvas.height);
                
                rocketCtx.shadowBlur = 30;
                rocketCtx.shadowColor = '#00ffff';
                rocketCtx.fillStyle = '#00ffff';
                rocketCtx.font = 'bold 120px Arial';
                rocketCtx.textAlign = 'center';
                rocketCtx.fillText(rocketCountdown, rocketCanvas.width / 2, rocketCanvas.height / 2 + 40);
                
                rocketCtx.shadowBlur = 0;
                rocketCtx.fillStyle = '#ffffff';
                rocketCtx.font = 'bold 30px Arial';
                rocketCtx.fillText('V√ÖG ' + rocketWave, rocketCanvas.width / 2, rocketCanvas.height / 2 - 60);
                rocketCtx.restore();
            }
        }

        function updateRocketUI() {
            document.getElementById('rocket-lives').textContent = rocketLives;
            document.getElementById('rocket-wave').textContent = rocketWave;
            document.getElementById('rocket-score').textContent = rocketScore;
        }

        function showRocketGlosQuestion() {
            if (rocketGlosIndex >= rocketGlosData.length) {
                rocketGlosIndex = 0;
                rocketGlosData.sort(() => Math.random() - 0.5);
            }

            const glos = rocketGlosData[rocketGlosIndex];
            const questionContainer = document.getElementById('rocket-question-container');
            const wordElement = document.getElementById('rocket-glos-word');
            const answerInput = document.getElementById('rocket-glos-answer');
            
            const mode = Math.random() < 0.5 ? 'svenska' : 'spanska';
            wordElement.textContent = mode === 'svenska' ? glos.svenska : glos.spanska;
            wordElement.dataset.mode = mode;
            answerInput.value = '';
            document.getElementById('rocket-glos-feedback').innerHTML = '';
            
            questionContainer.classList.remove('hidden');
            answerInput.focus();
            
            answerInput.onkeypress = (e) => {
                if (e.key === 'Enter') checkRocketGlosAnswer();
            };
        }

        function checkRocketGlosAnswer() {
            const glos = rocketGlosData[rocketGlosIndex];
            const answer = document.getElementById('rocket-glos-answer').value.trim().toLowerCase();
            const mode = document.getElementById('rocket-glos-word').dataset.mode;
            const correctAnswer = (mode === 'svenska' ? glos.spanska : glos.svenska).toLowerCase();
            const feedbackDiv = document.getElementById('rocket-glos-feedback');
            
            if (answer === correctAnswer) {
                feedbackDiv.innerHTML = '<div class="feedback correct">‚úÖ R√§tt! N√§sta v√•g startar!</div>';
                setTimeout(() => {
                    document.getElementById('rocket-question-container').classList.add('hidden');
                    rocketGlosIndex++;
                    rocketWave++;
                    if (rocketWave > 4) rocketWave = 1; // Reset to wave 1 after boss
                    updateRocketUI();
                    
                    // Clear old enemies and bullets
                    rocketEnemies = [];
                    rocketEnemyBullets = [];
                    
                    // Start countdown
                    rocketCountdown = 3;
                    rocketCountdownActive = true;
                    rocketPaused = false;
                    
                    // Spawn enemies after countdown
                    const countdownInterval = setInterval(() => {
                        rocketCountdown--;
                        if (rocketCountdown <= 0) {
                            clearInterval(countdownInterval);
                            rocketCountdownActive = false;
                            spawnEnemyWave();
                        }
                    }, 1000);
                }, 1500);
            } else {
                feedbackDiv.innerHTML = '<div class="feedback wrong">‚ùå Fel, f√∂rs√∂k igen!</div>';
            }
        }

        function gameOverRocket() {
            rocketGameRunning = false;
            rocketPaused = true;
            
            if (rocketGameLoop) {
                cancelAnimationFrame(rocketGameLoop);
                rocketGameLoop = null;
            }
            
            document.removeEventListener('keydown', handleRocketKeyDown);
            document.removeEventListener('keyup', handleRocketKeyUp);
            rocketKeys = {};
            
            alert(`Game Over! üí•\n\nDin slutpo√§ng: ${rocketScore}\nV√•gor klarade: ${rocketWave - 1}`);
            goToMainMenu();
        }

        // === BLOCKBLAST ===
        function goToBlockBlast() {
            showScreen('screen-blockblast-input');
            const container = document.getElementById('blockblast-glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                addBlockBlastGlosRow();
            }
        }

        function addBlockBlastGlosRow() {
            const container = document.getElementById('blockblast-glos-container');
            const row = document.createElement('div');
            row.className = 'glos-row';
            row.innerHTML = `
                <input type="text" placeholder="Svenskt ord" class="bb-glos-sv">
                <input type="text" placeholder="Spanskt ord" class="bb-glos-es">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function startBlockBlastGame() {
            blockBlastGlosData = [];
            document.querySelectorAll('#blockblast-glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.bb-glos-sv').value.trim();
                const es = row.querySelector('.bb-glos-es').value.trim();
                if (sv && es) {
                    blockBlastGlosData.push({ svenska: sv, spanska: es });
                }
            });

            if (blockBlastGlosData.length === 0) {
                alert('Du m√•ste l√§gga in minst en glos!');
                return;
            }

            blockBlastGlosData.sort(() => Math.random() - 0.5);
            currentGlosIndex = 0;
            initializeGame();
            showScreen('screen-blockblast');
        }

        function initializeGame() {
            gameGrid = Array(8).fill().map(() => Array(8).fill(0));
            gameScore = 0;
            usedPieces = 0;
            selectedPieceId = null;
            updateGameScore();
            renderGrid();
            generateNewPieces();
        }

        function renderGrid() {
            const gridElement = document.getElementById('game-board');
            gridElement.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell' + (gameGrid[row][col] ? ' filled' : '');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // Drop events
                    cell.ondragover = (e) => {
                        e.preventDefault();
                        if (selectedPieceId !== null) {
                            const piece = currentPieces[selectedPieceId];
                            if (!piece.used) {
                                highlightDropZone(row, col, piece.shape);
                            }
                        }
                    };
                    
                    cell.ondragleave = (e) => {
                        clearHighlights();
                    };
                    
                    cell.ondrop = (e) => {
                        e.preventDefault();
                        placePiece(row, col);
                    };
                    
                    cell.onclick = () => placePiece(row, col);
                    gridElement.appendChild(cell);
                }
            }
        }

        function highlightDropZone(row, col, shape) {
            clearHighlights();
            const canPlace = canPlacePiece(shape, row, col);
            
            for (let r = 0; r < shape.length; r++) {
                for (let c = 0; c < shape[0].length; c++) {
                    if (shape[r][c]) {
                        const targetRow = row + r;
                        const targetCol = col + c;
                        if (targetRow < 8 && targetCol < 8) {
                            const cellElement = document.querySelector(`[data-row="${targetRow}"][data-col="${targetCol}"]`);
                            if (cellElement) {
                                cellElement.classList.add(canPlace ? 'valid-drop' : 'invalid-drop');
                            }
                        }
                    }
                }
            }
        }

        function generateNewPieces() {
            currentPieces = [];
            usedPieces = 0;
            selectedPieceId = null;
            const container = document.getElementById('pieces-container');
            container.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const shape = pieceShapes[Math.floor(Math.random() * pieceShapes.length)];
                currentPieces.push({ shape, used: false, id: i });
                renderPiece(shape, i);
            }
            
            updatePiecesLeft();
        }

        function renderPiece(shape, id) {
            const container = document.getElementById('pieces-container');
            const pieceDiv = document.createElement('div');
            pieceDiv.className = 'piece';
            pieceDiv.dataset.pieceId = id;
            pieceDiv.draggable = true;
            pieceDiv.style.gridTemplateColumns = `repeat(${shape[0].length}, 30px)`;
            pieceDiv.style.gridTemplateRows = `repeat(${shape.length}, 30px)`;
            
            shape.forEach(row => {
                row.forEach(cell => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'piece-cell' + (cell ? ' active' : '');
                    pieceDiv.appendChild(cellDiv);
                });
            });
            
            // Drag events
            pieceDiv.ondragstart = (e) => {
                if (currentPieces[id].used) {
                    e.preventDefault();
                    return;
                }
                selectedPieceId = id;
                pieceDiv.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            };
            
            pieceDiv.ondragend = (e) => {
                pieceDiv.classList.remove('dragging');
                clearHighlights();
            };
            
            pieceDiv.onclick = () => selectPiece(id);
            container.appendChild(pieceDiv);
        }

        function selectPiece(id) {
            if (currentPieces[id].used) return;
            
            selectedPieceId = id;
            document.querySelectorAll('.piece').forEach(p => p.classList.remove('selected'));
            document.querySelector(`[data-piece-id="${id}"]`).classList.add('selected');
        }

        function clearHighlights() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('valid-drop', 'invalid-drop');
            });
        }

        function placePiece(row, col) {
            if (selectedPieceId === null) return;
            
            const piece = currentPieces[selectedPieceId];
            if (piece.used) return;
            
            if (canPlacePiece(piece.shape, row, col)) {
                for (let r = 0; r < piece.shape.length; r++) {
                    for (let c = 0; c < piece.shape[0].length; c++) {
                        if (piece.shape[r][c]) {
                            gameGrid[row + r][col + c] = 1;
                        }
                    }
                }
                
                piece.used = true;
                const pieceElement = document.querySelector(`[data-piece-id="${selectedPieceId}"]`);
                pieceElement.classList.add('used');
                pieceElement.draggable = false;
                usedPieces++;
                updatePiecesLeft();
                
                checkCompleteLines();
                renderGrid();
                clearHighlights();
                
                selectedPieceId = null;
                document.querySelectorAll('.piece').forEach(p => p.classList.remove('selected'));
                
                if (usedPieces === 4) {
                    showGlosQuestion();
                }
            }
        }

        function canPlacePiece(shape, row, col) {
            for (let r = 0; r < shape.length; r++) {
                for (let c = 0; c < shape[0].length; c++) {
                    if (shape[r][c]) {
                        if (row + r >= 8 || col + c >= 8 || gameGrid[row + r][col + c]) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function checkCompleteLines() {
            let linesCleared = 0;
            
            for (let row = 0; row < 8; row++) {
                if (gameGrid[row].every(cell => cell === 1)) {
                    gameGrid[row].fill(0);
                    linesCleared++;
                }
            }
            
            for (let col = 0; col < 8; col++) {
                let columnFull = true;
                for (let row = 0; row < 8; row++) {
                    if (gameGrid[row][col] === 0) {
                        columnFull = false;
                        break;
                    }
                }
                if (columnFull) {
                    for (let row = 0; row < 8; row++) {
                        gameGrid[row][col] = 0;
                    }
                    linesCleared++;
                }
            }
            
            if (linesCleared > 0) {
                gameScore += linesCleared * 10;
                updateGameScore();
            }
        }

        function updateGameScore() {
            document.getElementById('game-score').textContent = gameScore;
        }

        function updatePiecesLeft() {
            document.getElementById('pieces-left').textContent = 4 - usedPieces;
        }

        function showGlosQuestion() {
            // Rotera genom glosorna - b√∂rja om n√§r alla √§r genomg√•ngna
            if (currentGlosIndex >= blockBlastGlosData.length) {
                currentGlosIndex = 0;
                blockBlastGlosData.sort(() => Math.random() - 0.5); // Blanda om f√∂r variation
            }

            const glos = blockBlastGlosData[currentGlosIndex];
            const questionContainer = document.getElementById('glos-question-container');
            const wordElement = document.getElementById('glos-word');
            const answerInput = document.getElementById('glos-answer');
            
            glosMode = Math.random() < 0.5 ? 'svenska' : 'spanska';
            wordElement.textContent = glosMode === 'svenska' ? glos.svenska : glos.spanska;
            answerInput.value = '';
            document.getElementById('glos-feedback').innerHTML = '';
            
            questionContainer.classList.remove('hidden');
            answerInput.focus();
            
            answerInput.onkeypress = (e) => {
                if (e.key === 'Enter') checkGlosAnswer();
            };
        }

        function checkGlosAnswer() {
            const glos = blockBlastGlosData[currentGlosIndex];
            const answer = document.getElementById('glos-answer').value.trim().toLowerCase();
            const correctAnswer = (glosMode === 'svenska' ? glos.spanska : glos.svenska).toLowerCase();
            const feedbackDiv = document.getElementById('glos-feedback');
            
            if (answer === correctAnswer) {
                feedbackDiv.innerHTML = '<div class="feedback correct">‚úÖ R√§tt! Du f√•r nya bitar!</div>';
                setTimeout(() => {
                    document.getElementById('glos-question-container').classList.add('hidden');
                    currentGlosIndex++;
                    generateNewPieces();
                }, 1500);
            } else {
                feedbackDiv.innerHTML = '<div class="feedback wrong">‚ùå Fel, f√∂rs√∂k igen!</div>';
            }
        }

        // === GLOSOR ===
        function initializeGlosInput() {
            const container = document.getElementById('glos-container');
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                addGlosRow();
            }
        }

        function addGlosRow() {
            const container = document.getElementById('glos-container');
            const row = document.createElement('div');
            row.className = 'glos-row';
            row.innerHTML = `
                <input type="text" placeholder="Svenskt ord" class="glos-sv">
                <input type="text" placeholder="Spanskt ord" class="glos-es">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        }

        function selectGlosDirection() {
            glosData = [];
            document.querySelectorAll('#glos-container .glos-row').forEach(row => {
                const sv = row.querySelector('.glos-sv').value.trim();
                const es = row.querySelector('.glos-es').value.trim();
                if (sv && es) {
                    glosData.push({ svenska: sv, spanska: es });
                }
            });

            if (glosData.length === 0) {
                alert('Du m√•ste l√§gga in minst en glos!');
                return;
            }

            showScreen('screen-glos-direction');
        }

        function startGlosTest(direction) {
            mode = direction;
            currentWords = [...glosData];
            currentWords.sort(() => Math.random() - 0.5);
            
            currentIndex = 0;
            correct = 0;
            wrong = 0;
            attemptsLeft = 2;
            
            showScreen('screen-test');
            displayQuestion();
        }

        // === VERB ===
        function initializeVerbInput() {
            const container = document.getElementById('verb-container');
            container.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                addVerbForm();
            }
        }

        function addVerbForm() {
            const container = document.getElementById('verb-container');
            const formDiv = document.createElement('div');
            formDiv.className = 'verb-form';
            formDiv.innerHTML = `
                <label>Verb (grundform):</label>
                <input type="text" placeholder="t.ex. Ser, Hacer, etc." class="verb-name">
                <label>yo:</label>
                <input type="text" placeholder="t.ex. soy, hago" class="verb-yo">
                <label>t√∫:</label>
                <input type="text" placeholder="t.ex. eres, haces" class="verb-tu">
                <label>√©l/ella:</label>
                <input type="text" placeholder="t.ex. es, hace" class="verb-el">
                <label>nosotros:</label>
                <input type="text" placeholder="t.ex. somos, hacemos" class="verb-nosotros">
                <label>vosotros:</label>
                <input type="text" placeholder="t.ex. sois, hac√©is" class="verb-vosotros">
                <label>ellos/ellas:</label>
                <input type="text" placeholder="t.ex. son, hacen" class="verb-ellos">
                <button class="remove-btn" onclick="this.parentElement.remove()" style="margin-top: 10px; width: 100%;">Ta bort verb</button>
            `;
            container.appendChild(formDiv);
        }

        function startVerbTest() {
            verbData = [];
            document.querySelectorAll('.verb-form').forEach(form => {
                const name = form.querySelector('.verb-name').value.trim();
                const yo = form.querySelector('.verb-yo').value.trim();
                const tu = form.querySelector('.verb-tu').value.trim();
                const el = form.querySelector('.verb-el').value.trim();
                const nosotros = form.querySelector('.verb-nosotros').value.trim();
                const vosotros = form.querySelector('.verb-vosotros').value.trim();
                const ellos = form.querySelector('.verb-ellos').value.trim();
                
                if (name && yo && tu && el && nosotros && vosotros && ellos) {
                    verbData.push({
                        svenska: name,
                        spanska: [yo, tu, el, nosotros, vosotros, ellos]
                    });
                }
            });

            if (verbData.length === 0) {
                alert('Du m√•ste l√§gga in minst ett verb med alla b√∂jningar!');
                return;
            }

            testType = 'verb';
            currentWords = [...verbData];
            currentWords.sort(() => Math.random() - 0.5);
            
            currentIndex = 0;
            correct = 0;
            wrong = 0;
            attemptsLeft = 2;
            
            showScreen('screen-test');
            displayQuestion();
        }

        // === TEST ===
        function displayQuestion() {
            if (currentIndex >= currentWords.length) {
                showResults();
                return;
            }

            const item = currentWords[currentIndex];
            document.getElementById('progress').textContent = `Ord ${currentIndex + 1} av ${currentWords.length}`;
            document.getElementById('feedback').innerHTML = '';

            if (testType === 'glosor') {
                const displayWord = mode === 'svenska' ? item.svenska : item.spanska;
                document.getElementById('question').textContent = displayWord;
                document.getElementById('answer-area').innerHTML = `
                    <input type="text" class="input-box" id="answer-input" placeholder="Skriv ditt svar h√§r...">
                `;
                document.getElementById('answer-input').focus();
                document.getElementById('answer-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') checkAnswer();
                });
            } else if (testType === 'verb') {
                document.getElementById('question').textContent = item.svenska;
                let html = '';
                correctFlags = Array(6).fill(false);
                
                for (let i = 0; i < 6; i++) {
                    html += `
                        <div class="irreg-input-row">
                            <div class="irreg-label">${labels[i]} =</div>
                            <input type="text" class="input-box" id="input-${i}" placeholder="Skriv b√∂jningen...">
                        </div>
                    `;
                }
                document.getElementById('answer-area').innerHTML = html;
                document.getElementById('input-0').focus();
                
                for (let i = 0; i < 6; i++) {
                    document.getElementById(`input-${i}`).addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') checkAnswer();
                    });
                }
            }
        }

        function checkAnswer() {
            const item = currentWords[currentIndex];
            const feedbackDiv = document.getElementById('feedback');

            if (testType === 'glosor') {
                const answer = document.getElementById('answer-input').value.trim().toLowerCase();
                const correctAnswer = (mode === 'svenska' ? item.spanska : item.svenska).toLowerCase();

                if (answer === correctAnswer) {
                    feedbackDiv.innerHTML = '<div class="feedback correct">‚úÖ R√§tt!</div>';
                    correct++;
                    setTimeout(() => {
                        currentIndex++;
                        attemptsLeft = 2;
                        displayQuestion();
                    }, 1500);
                } else {
                    attemptsLeft--;
                    if (attemptsLeft === 0) {
                        const displayCorrect = mode === 'svenska' ? item.spanska : item.svenska;
                        feedbackDiv.innerHTML = `<div class="feedback wrong">‚ùå Fel! R√§tt svar: ${displayCorrect}</div>`;
                        wrong++;
                        setTimeout(() => {
                            currentIndex++;
                            attemptsLeft = 2;
                            displayQuestion();
                        }, 3000);
                    } else {
                        feedbackDiv.innerHTML = '<div class="feedback wrong">‚ùå Fel, f√∂rs√∂k igen!</div>';
                    }
                }
            } else if (testType === 'verb') {
                const correctForms = item.spanska.map(f => f.toLowerCase());
                let newlyCorrect = 0;
                let totalCorrect = 0;

                for (let i = 0; i < 6; i++) {
                    const input = document.getElementById(`input-${i}`);
                    const answer = input.value.trim().toLowerCase();
                    
                    if (!correctFlags[i] && answer === correctForms[i]) {
                        correctFlags[i] = true;
                        newlyCorrect++;
                        input.classList.add('correct');
                        input.disabled = true;
                    }
                    
                    if (correctFlags[i]) totalCorrect++;
                }

                if (totalCorrect === 6) {
                    feedbackDiv.innerHTML = '<div class="feedback correct">‚úÖ R√§tt p√• alla b√∂jningar!</div>';
                    correct++;
                    setTimeout(() => {
                        currentIndex++;
                        attemptsLeft = 2;
                        displayQuestion();
                    }, 2000);
                } else {
                    attemptsLeft--;
                    if (attemptsLeft === 0) {
                        feedbackDiv.innerHTML = `<div class="feedback wrong">‚ùå Fel! R√§tt svar: ${item.spanska.join(', ')}</div>`;
                        wrong++;
                        setTimeout(() => {
                            currentIndex++;
                            attemptsLeft = 2;
                            displayQuestion();
                        }, 3000);
                    } else {
                        if (newlyCorrect > 0) {
                            feedbackDiv.innerHTML = `<div class="feedback correct">‚úÖ ${newlyCorrect} nya r√§tt! Totalt ${totalCorrect}/6. F√∂rs√∂k igen med resten!</div>`;
                        } else {
                            feedbackDiv.innerHTML = `<div class="feedback wrong">‚ùå Inga nya r√§tt. ${totalCorrect}/6 klara. F√∂rs√∂k igen!</div>`;
                        }
                        
                        for (let i = 0; i < 6; i++) {
                            if (!correctFlags[i]) {
                                document.getElementById(`input-${i}`).value = '';
                            }
                        }
                    }
                }
            }
        }

        function showResults() {
            document.getElementById('final-correct').textContent = correct;
            document.getElementById('final-wrong').textContent = wrong;
            showScreen('screen-result');
        }

        function restartTest() {
            if (testType === 'glosor') {
                startGlosTest(mode);
            } else if (testType === 'verb') {
                startVerbTest();
            }
        }
    </script>
</body>
</html> 
